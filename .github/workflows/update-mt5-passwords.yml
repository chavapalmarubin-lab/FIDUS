name: Update MT5 Account Passwords

on:
  workflow_dispatch:
    inputs:
      new_password:
        description: 'New password for MT5/MT4 accounts'
        required: true
        type: string
      update_mex_atlantic:
        description: 'Update MEX Atlantic accounts (14 accounts)'
        required: true
        type: boolean
        default: true
      update_lucrum:
        description: 'Update Lucrum Capital accounts (7 accounts)'
        required: true
        type: boolean
        default: true
      dry_run:
        description: 'Dry run (no actual updates)'
        required: true
        type: boolean
        default: true

jobs:
  update-passwords:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install motor pymongo

      - name: Update MongoDB Passwords
        env:
          MONGO_URL: ${{ secrets.MONGO_URL }}
          NEW_PASSWORD: ${{ inputs.new_password }}
          UPDATE_MEX: ${{ inputs.update_mex_atlantic }}
          UPDATE_LUCRUM: ${{ inputs.update_lucrum }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          python << 'EOF'
          import asyncio
          import os
          from motor.motor_asyncio import AsyncIOMotorClient
          from datetime import datetime, timezone

          async def update_passwords():
              mongo_url = os.environ.get('MONGO_URL')
              new_password = os.environ.get('NEW_PASSWORD')
              update_mex = os.environ.get('UPDATE_MEX', 'true').lower() == 'true'
              update_lucrum = os.environ.get('UPDATE_LUCRUM', 'true').lower() == 'true'
              dry_run = os.environ.get('DRY_RUN', 'true').lower() == 'true'
              
              if not mongo_url:
                  print("âŒ ERROR: MONGO_URL secret not configured")
                  exit(1)
              
              if not new_password:
                  print("âŒ ERROR: New password not provided")
                  exit(1)
              
              print("=" * 70)
              print("MT5/MT4 PASSWORD UPDATE - MongoDB")
              print("=" * 70)
              print(f"Dry Run: {dry_run}")
              print(f"Update MEX Atlantic: {update_mex}")
              print(f"Update Lucrum Capital: {update_lucrum}")
              print(f"New Password: {'*' * len(new_password)}")
              print("=" * 70)
              
              # Account lists
              MEX_ACCOUNTS = [
                  885822, 886066, 886528, 886557, 886602,
                  891215, 891234, 897589, 897590, 897591,
                  897599, 901351, 901353, 33200931
              ]
              
              LUCRUM_ACCOUNTS = [2198, 2199, 2205, 2206, 2207, 2208, 2209]
              
              accounts_to_update = []
              if update_mex:
                  accounts_to_update.extend(MEX_ACCOUNTS)
              if update_lucrum:
                  accounts_to_update.extend(LUCRUM_ACCOUNTS)
              
              if not accounts_to_update:
                  print("âš ï¸ No accounts selected for update")
                  return
              
              print(f"\nAccounts to update: {len(accounts_to_update)}")
              
              client = AsyncIOMotorClient(mongo_url)
              db = client['fidus_production']
              
              # Update mt5_account_config
              print("\nðŸ“¦ Updating mt5_account_config collection...")
              if dry_run:
                  count = await db.mt5_account_config.count_documents({'account': {'$in': accounts_to_update}})
                  print(f"   [DRY RUN] Would update {count} configs")
              else:
                  result = await db.mt5_account_config.update_many(
                      {'account': {'$in': accounts_to_update}},
                      {
                          '$set': {
                              'password': new_password,
                              'updated_at': datetime.now(timezone.utc),
                              'last_modified_by': 'github_action_password_update'
                          }
                      }
                  )
                  print(f"   âœ… Updated {result.modified_count} configs")
              
              # Update mt5_accounts
              print("\nðŸ“¦ Updating mt5_accounts collection...")
              if dry_run:
                  count = await db.mt5_accounts.count_documents({
                      'account': {'$in': accounts_to_update},
                      'password': {'$exists': True}
                  })
                  print(f"   [DRY RUN] Would update {count} accounts")
              else:
                  result = await db.mt5_accounts.update_many(
                      {'account': {'$in': accounts_to_update}},
                      {'$set': {'password': new_password}}
                  )
                  print(f"   âœ… Updated {result.modified_count} accounts")
              
              # Verification
              print("\nðŸ” Verification:")
              for acc in accounts_to_update[:5]:
                  config = await db.mt5_account_config.find_one(
                      {'account': acc},
                      {'_id': 0, 'account': 1, 'server': 1, 'password': 1}
                  )
                  if config:
                      pwd = config.get('password', '')
                      if dry_run:
                          print(f"   Account {acc}: Current password stored")
                      else:
                          status = "âœ…" if pwd == new_password else "âŒ"
                          print(f"   {status} Account {acc}: Password updated")
              
              if len(accounts_to_update) > 5:
                  print(f"   ... and {len(accounts_to_update) - 5} more accounts")
              
              print("\n" + "=" * 70)
              if dry_run:
                  print("ðŸ”¶ DRY RUN COMPLETE - No changes made")
                  print("   Re-run with dry_run=false to apply changes")
              else:
                  print("âœ… PASSWORD UPDATE COMPLETE")
              print("=" * 70)

          asyncio.run(update_passwords())
          EOF

      - name: Summary
        run: |
          echo "## MT5 Password Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MEX Atlantic | ${{ inputs.update_mex_atlantic }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lucrum Capital | ${{ inputs.update_lucrum }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "âš ï¸ **This was a dry run. No changes were made.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Passwords updated in MongoDB.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Update passwords on VPS MT5/MT4 terminals" >> $GITHUB_STEP_SUMMARY
            echo "2. Update Python bridge config files on VPS" >> $GITHUB_STEP_SUMMARY
            echo "3. Verify bridge reconnects successfully" >> $GITHUB_STEP_SUMMARY
          fi
