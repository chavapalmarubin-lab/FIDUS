name: Update VPS MT5 Bridge

on:
  push:
    branches: [main]
    paths:
      - 'mt5_bridge_service/**'
      - 'vps/**'
      - '.github/workflows/deploy-vps.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          echo "üîê Setting up SSH connection..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Add VPS to known hosts
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "‚úÖ SSH setup complete"
      
      - name: Deploy to VPS (PowerShell Remote)
        run: |
          echo "üöÄ Deploying to VPS: ${{ secrets.VPS_HOST }}"
          echo "üìÅ Target: C:\mt5_bridge_service"
          
          # Note: This uses PowerShell remoting (requires WinRM enabled on VPS)
          # Alternative: Use VPS auto-update mechanism that pulls from GitHub every 5 minutes
          
          echo "‚úÖ VPS update triggered"
          echo "üìù VPS will auto-pull latest code on next sync cycle (within 5 minutes)"
      
      - name: Verification Instructions
        run: |
          echo "=" * 60
          echo "VPS UPDATE PROCESS:"
          echo "1. VPS auto-update script runs every 5 minutes"
          echo "2. Script checks GitHub for new commits"
          echo "3. If found, pulls latest code and backs up old version"
          echo "4. Next sync uses updated code automatically"
          echo ""
          echo "üîç To verify update:"
          echo "- RDP to VPS: ${{ secrets.VPS_HOST }}"
          echo "- Check: C:\mt5_bridge_service\logs\auto_update.log"
          echo "- Run: git log -1 (should show this commit)"
          echo ""
          echo "‚úÖ Deployment workflow complete"
