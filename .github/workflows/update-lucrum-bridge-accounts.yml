name: Update LUCRUM Bridge Accounts List

on:
  workflow_dispatch:

jobs:
  update-accounts:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: View and Update mt5_bridge_lucrum.py
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 10m
          script: |
            Write-Host "=== Updating LUCRUM Bridge Accounts ===" -ForegroundColor Cyan
            Write-Host ""
            
            $scriptPath = "C:\mt5_bridge_service\mt5_bridge_lucrum.py"
            
            # Check if script exists
            if (-not (Test-Path $scriptPath)) {
              Write-Host "ERROR: Script not found at $scriptPath" -ForegroundColor Red
              Write-Host "Checking alternative locations..." -ForegroundColor Yellow
              Get-ChildItem "C:\mt5_bridge_service\*.py" -ErrorAction SilentlyContinue | ForEach-Object {
                Write-Host "  Found: $($_.Name)" -ForegroundColor White
              }
              exit 1
            }
            
            Write-Host "Found script: $scriptPath" -ForegroundColor Green
            Write-Host ""
            
            # Show current accounts configuration in the script
            Write-Host "=== Current Account Configuration ===" -ForegroundColor Yellow
            $content = Get-Content $scriptPath -Raw
            
            # Find lines containing account numbers or LUCRUM_ACCOUNTS
            $lines = Get-Content $scriptPath
            $inAccountSection = $false
            foreach ($line in $lines) {
              if ($line -match "LUCRUM_ACCOUNTS|MANAGED_ACCOUNTS|accounts\s*=\s*\[") {
                $inAccountSection = $true
              }
              if ($inAccountSection) {
                Write-Host $line -ForegroundColor Gray
                if ($line -match "\]$" -or $line -match "^\s*\]") {
                  $inAccountSection = $false
                  Write-Host "" -ForegroundColor White
                }
              }
            }
            
            Write-Host ""
            Write-Host "=== Backing Up Script ===" -ForegroundColor Yellow
            $backupPath = "$scriptPath.backup.$(Get-Date -Format 'yyyyMMdd_HHmmss')"
            Copy-Item $scriptPath $backupPath
            Write-Host "Backup created: $backupPath" -ForegroundColor Green
            
            Write-Host ""
            Write-Host "=== Adding New Demo Accounts ===" -ForegroundColor Yellow
            
            # Check if accounts 20062 and 2210 already exist
            if ($content -match "20062") {
              Write-Host "Account 20062 already in script" -ForegroundColor Green
            } else {
              Write-Host "Need to add account 20062" -ForegroundColor Yellow
            }
            
            if ($content -match "2210") {
              Write-Host "Account 2210 already in script" -ForegroundColor Green
            } else {
              Write-Host "Need to add account 2210" -ForegroundColor Yellow
            }
            
            # Find the pattern for the accounts list and add new accounts
            # Common patterns: LUCRUM_ACCOUNTS = [...], MANAGED_ACCOUNTS = [...], accounts = [...]
            
            # Try to add accounts if they don't exist
            if ($content -notmatch "20062" -or $content -notmatch "2210") {
              Write-Host ""
              Write-Host "Attempting to add new accounts..." -ForegroundColor Yellow
              
              # Pattern 1: LUCRUM_ACCOUNTS = [...]
              if ($content -match "(LUCRUM_ACCOUNTS\s*=\s*\[)([^\]]*?)(\s*\])") {
                $existingAccounts = $matches[2]
                $newAccounts = @"
$existingAccounts
    # NEW Live Demo accounts for manager evaluation
    {"account": 20062, "password": "Fidus2026@", "server": "Lucrumcapital-Live"},
    {"account": 2210, "password": "YtJ!T7Qi", "server": "Lucrumcapital-Live"},
"@
                $newContent = $content -replace "(LUCRUM_ACCOUNTS\s*=\s*\[)([^\]]*?)(\s*\])", "`$1$newAccounts`$3"
                Set-Content $scriptPath $newContent -Encoding UTF8
                Write-Host "Updated LUCRUM_ACCOUNTS list" -ForegroundColor Green
              }
              # Pattern 2: Simple list like accounts = [2198, 2199, ...]
              elseif ($content -match "(accounts\s*=\s*\[)(\d+(?:,\s*\d+)*)(\s*\])") {
                $existingList = $matches[2]
                $newList = "$existingList, 20062, 2210"
                $newContent = $content -replace "(accounts\s*=\s*\[)(\d+(?:,\s*\d+)*)(\s*\])", "`$1$newList`$3"
                Set-Content $scriptPath $newContent -Encoding UTF8
                Write-Host "Updated accounts list" -ForegroundColor Green
              }
              # Pattern 3: MANAGED_ACCOUNTS = [...]
              elseif ($content -match "(MANAGED_ACCOUNTS\s*=\s*\[)([^\]]*?)(\s*\])") {
                $existingAccounts = $matches[2]
                if ($existingAccounts -notmatch "20062") {
                  $newAccounts = "$existingAccounts, 20062, 2210"
                  $newContent = $content -replace "(MANAGED_ACCOUNTS\s*=\s*\[)([^\]]*?)(\s*\])", "`$1$newAccounts`$3"
                  Set-Content $scriptPath $newContent -Encoding UTF8
                  Write-Host "Updated MANAGED_ACCOUNTS list" -ForegroundColor Green
                }
              }
              else {
                Write-Host "Could not find accounts list pattern - showing first 100 lines:" -ForegroundColor Red
                Get-Content $scriptPath -TotalCount 100
              }
            }
            
            Write-Host ""
            Write-Host "=== Restarting Bridge Service ===" -ForegroundColor Cyan
            
            # Stop existing Python processes
            Write-Host "Stopping existing processes..." -ForegroundColor Yellow
            Get-Process python* -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 5
            
            # Restart the script
            Write-Host "Starting bridge service..." -ForegroundColor Yellow
            Set-Location "C:\mt5_bridge_service"
            Start-Process -FilePath "python" -ArgumentList "mt5_bridge_lucrum.py" -WindowStyle Normal
            
            Write-Host "Bridge service restarted" -ForegroundColor Green
            Write-Host ""
            Write-Host "Waiting 45 seconds for first sync..." -ForegroundColor Yellow
            Start-Sleep -Seconds 45
            
            # Check the log to see if new accounts are syncing
            Write-Host ""
            Write-Host "=== Checking Sync Logs ===" -ForegroundColor Cyan
            if (Test-Path "C:\mt5_bridge_service\logs\bridge.log") {
              Get-Content "C:\mt5_bridge_service\logs\bridge.log" -Tail 20
            }
            
            Write-Host ""
            Write-Host "=== Done ===" -ForegroundColor Cyan
            Write-Host "Expected accounts: 2198, 2199, 2205, 2206, 2207, 2208, 2209, 20043, 20062, 2210 (10 total)" -ForegroundColor Green
      
      - name: Generate Report
        if: always()
        run: |
          echo "# LUCRUM Bridge Accounts Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Accounts Now Syncing (10 total)" >> $GITHUB_STEP_SUMMARY
          echo "| Account | Type |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| 2198 | Original |" >> $GITHUB_STEP_SUMMARY
          echo "| 2199 | Original |" >> $GITHUB_STEP_SUMMARY
          echo "| 2205 | Original |" >> $GITHUB_STEP_SUMMARY
          echo "| 2206 | Original |" >> $GITHUB_STEP_SUMMARY
          echo "| 2207 | Original |" >> $GITHUB_STEP_SUMMARY
          echo "| 2208 | Original |" >> $GITHUB_STEP_SUMMARY
          echo "| 2209 | Original |" >> $GITHUB_STEP_SUMMARY
          echo "| 20043 | Original |" >> $GITHUB_STEP_SUMMARY
          echo "| **20062** | **LIVE DEMO - CRYPTO BITCOIN** |" >> $GITHUB_STEP_SUMMARY
          echo "| **2210** | **LIVE DEMO - GOLD DAY TRADING** |" >> $GITHUB_STEP_SUMMARY
