name: Update LUCRUM Bridge Accounts List

on:
  workflow_dispatch:

jobs:
  update-accounts:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: View and Update mt5_bridge_lucrum.py
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 10m
          script: |
            Write-Host "=== Updating LUCRUM Bridge Accounts ===" -ForegroundColor Cyan
            Write-Host ""
            
            $scriptPath = "C:\mt5_bridge_service\mt5_bridge_lucrum.py"
            
            if (-not (Test-Path $scriptPath)) {
              Write-Host "ERROR: Script not found at $scriptPath" -ForegroundColor Red
              Get-ChildItem "C:\mt5_bridge_service\*.py" -ErrorAction SilentlyContinue
              exit 1
            }
            
            Write-Host "Found script: $scriptPath" -ForegroundColor Green
            Write-Host ""
            
            # Show current accounts
            Write-Host "=== Current Account Configuration ===" -ForegroundColor Yellow
            Get-Content $scriptPath | Select-String -Pattern "LUCRUM_ACCOUNTS|MANAGED_ACCOUNTS|account.*2198|account.*2199|account.*20062|account.*2210"
            
            Write-Host ""
            Write-Host "=== Backing Up Script ===" -ForegroundColor Yellow
            Copy-Item $scriptPath "$scriptPath.backup"
            Write-Host "Backup created" -ForegroundColor Green
            
            # Read content
            $content = Get-Content $scriptPath -Raw
            
            # Check if accounts already exist
            $has20062 = $content -match "20062"
            $has2210 = $content -match "2210"
            
            Write-Host ""
            Write-Host "Account 20062 exists: $has20062" -ForegroundColor White
            Write-Host "Account 2210 exists: $has2210" -ForegroundColor White
            
            if (-not $has20062 -or -not $has2210) {
              Write-Host ""
              Write-Host "Adding new demo accounts..." -ForegroundColor Yellow
              
              # Add accounts before the closing bracket of MANAGED_ACCOUNTS
              $newLine1 = '    20062,  # LIVE DEMO - CRYPTO BITCOIN'
              $newLine2 = '    2210,   # LIVE DEMO - GOLD DAY TRADING'
              
              # Find MANAGED_ACCOUNTS and add before closing ]
              if ($content -match "MANAGED_ACCOUNTS\s*=\s*\[") {
                $content = $content -replace "(MANAGED_ACCOUNTS\s*=\s*\[[^\]]+)(]\s*)", "`$1`n$newLine1`n$newLine2`n`$2"
                Set-Content $scriptPath $content -Encoding UTF8
                Write-Host "Added to MANAGED_ACCOUNTS" -ForegroundColor Green
              }
              elseif ($content -match "LUCRUM_ACCOUNTS\s*=\s*\[") {
                $content = $content -replace "(LUCRUM_ACCOUNTS\s*=\s*\[[^\]]+)(]\s*)", "`$1`n$newLine1`n$newLine2`n`$2"
                Set-Content $scriptPath $content -Encoding UTF8
                Write-Host "Added to LUCRUM_ACCOUNTS" -ForegroundColor Green
              }
              else {
                Write-Host "Could not find accounts list - showing script structure:" -ForegroundColor Red
                Get-Content $scriptPath -TotalCount 80
              }
            }
            else {
              Write-Host "Both accounts already exist in script" -ForegroundColor Green
            }
            
            Write-Host ""
            Write-Host "=== Restarting Bridge Service ===" -ForegroundColor Cyan
            
            Get-Process python* -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 5
            
            Set-Location "C:\mt5_bridge_service"
            Start-Process -FilePath "python" -ArgumentList "mt5_bridge_lucrum.py" -WindowStyle Normal
            
            Write-Host "Bridge service restarted" -ForegroundColor Green
            Write-Host "Waiting 45 seconds for sync..." -ForegroundColor Yellow
            Start-Sleep -Seconds 45
            
            Write-Host ""
            Write-Host "=== Checking Results ===" -ForegroundColor Cyan
            Get-Content $scriptPath | Select-String -Pattern "20062|2210"
            
            Write-Host ""
            Write-Host "Done! Expected 10 accounts total." -ForegroundColor Green
      
      - name: Generate Report
        if: always()
        run: |
          echo "# LUCRUM Bridge Accounts Update" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## New Demo Accounts Added" >> $GITHUB_STEP_SUMMARY
          echo "- **20062** - CRYPTO BITCOIN" >> $GITHUB_STEP_SUMMARY
          echo "- **2210** - GOLD DAY TRADING" >> $GITHUB_STEP_SUMMARY
