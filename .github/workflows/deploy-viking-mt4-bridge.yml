# ============================================================
# VIKING MT4 Bridge Deployment Workflow
# ============================================================
# Deploys VIKING bridge components to VPS
# COMPLETELY SEPARATE from FIDUS MT5 bridge
# ============================================================

name: Deploy VIKING MT4 Bridge

on:
  workflow_dispatch:
    inputs:
      deploy_ea:
        description: 'Deploy MT4 EA to terminal'
        required: false
        default: 'true'
        type: boolean
      deploy_service:
        description: 'Deploy Python bridge service'
        required: false
        default: 'true'
        type: boolean
      restart_service:
        description: 'Restart bridge service after deploy'
        required: false
        default: 'true'
        type: boolean

env:
  # VIKING specific paths
  VIKING_BRIDGE_PATH: /opt/viking_bridge
  MT4_EXPERTS_PATH: 'C:\Program Files\MEXAtlantic MT4 Terminal\MQL4\Experts'

jobs:
  deploy-viking-bridge:
    runs-on: ubuntu-latest
    name: Deploy VIKING MT4 Bridge
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Validate files exist
        run: |
          echo "ðŸ” Validating VIKING bridge files..."
          
          if [ ! -f "backend/mt4_bridge/VIKING_MT4_Bridge.mq4" ]; then
            echo "âŒ EA file not found!"
            exit 1
          fi
          
          if [ ! -f "backend/mt4_bridge/viking_mt4_bridge_service.py" ]; then
            echo "âŒ Python service not found!"
            exit 1
          fi
          
          echo "âœ… All files validated"
      
      - name: Deploy Python Bridge Service
        if: ${{ inputs.deploy_service }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 60s
          command_timeout: 60s
          script: |
            Write-Host "ðŸš€ Deploying VIKING Bridge Service..." -ForegroundColor Cyan
            
            # Create directory if not exists
            $vikingPath = "C:\viking_bridge"
            if (-not (Test-Path $vikingPath)) {
                New-Item -ItemType Directory -Path $vikingPath -Force
                Write-Host "âœ… Created directory: $vikingPath" -ForegroundColor Green
            }
            
            # Stop existing service if running
            $process = Get-Process -Name "python*" -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like "*viking*" }
            if ($process) {
                Write-Host "â¹ï¸ Stopping existing VIKING bridge..." -ForegroundColor Yellow
                $process | Stop-Process -Force
                Start-Sleep -Seconds 2
            }
            
            Write-Host "âœ… Directory prepared: $vikingPath" -ForegroundColor Green
      
      - name: Copy service files to VPS
        if: ${{ inputs.deploy_service }}
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          source: "backend/mt4_bridge/viking_mt4_bridge_service.py,backend/mt4_bridge/requirements_viking.txt,backend/mt4_bridge/start_viking_bridge.bat"
          target: 'C:\viking_bridge'
          strip_components: 2
      
      - name: Install dependencies and start service
        if: ${{ inputs.deploy_service && inputs.restart_service }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 120s
          command_timeout: 120s
          script: |
            Write-Host "ðŸ“¦ Installing Python dependencies..." -ForegroundColor Cyan
            
            cd C:\viking_bridge
            
            pip install -r requirements_viking.txt
            
            Write-Host "ðŸš€ Starting VIKING bridge service..." -ForegroundColor Cyan
            
            # Start service in background
            Start-Process -FilePath "python" -ArgumentList "viking_mt4_bridge_service.py" -WorkingDirectory "C:\viking_bridge" -WindowStyle Hidden
            
            Start-Sleep -Seconds 3
            
            # Verify service started
            $process = Get-Process -Name "python*" -ErrorAction SilentlyContinue
            if ($process) {
                Write-Host "âœ… VIKING bridge service started successfully" -ForegroundColor Green
                Write-Host "ðŸ“Š Service running on port 8001" -ForegroundColor Green
            } else {
                Write-Host "âŒ Failed to start service" -ForegroundColor Red
            }
      
      - name: Copy EA file to VPS
        if: ${{ inputs.deploy_ea }}
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          source: "backend/mt4_bridge/VIKING_MT4_Bridge.mq4"
          target: 'C:\viking_bridge'
          strip_components: 2
      
      - name: Deploy MT4 EA file
        if: ${{ inputs.deploy_ea }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 60s
          command_timeout: 60s
          script: |
            Write-Host "ðŸ“ Deploying VIKING MT4 EA..." -ForegroundColor Cyan
            
            $eaSource = "C:\viking_bridge\VIKING_MT4_Bridge.mq4"
            $eaDest = "C:\Program Files\MEXAtlantic MT4 Terminal\MQL4\Experts\VIKING_MT4_Bridge.mq4"
            
            if (Test-Path $eaSource) {
                Copy-Item -Path $eaSource -Destination $eaDest -Force
                Write-Host "âœ… EA copied to MT4 Experts folder" -ForegroundColor Green
            } else {
                Write-Host "âš ï¸ EA source file not found at: $eaSource" -ForegroundColor Yellow
            }
            
            Write-Host ""
            Write-Host "ðŸ“‹ EA deployment notes:" -ForegroundColor Cyan
            Write-Host "  1. EA file is at: $eaDest"
            Write-Host "  2. Compile in MetaEditor if needed"
            Write-Host "  3. Attach to any chart on account 33627673"
            Write-Host "  4. Enable WebRequest for localhost:8001"
      
      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 60s
          command_timeout: 60s
          script: |
            Write-Host ""
            Write-Host "============================================================" -ForegroundColor Cyan
            Write-Host "   VIKING MT4 Bridge Deployment Summary" -ForegroundColor Cyan
            Write-Host "============================================================" -ForegroundColor Cyan
            Write-Host ""
            
            Write-Host "ðŸ“ Files deployed to: C:\viking_bridge" -ForegroundColor White
            Get-ChildItem -Path "C:\viking_bridge" -ErrorAction SilentlyContinue | Format-Table Name, Length, LastWriteTime
            
            Write-Host ""
            Write-Host "ðŸ”„ Service Status:" -ForegroundColor White
            $process = Get-Process -Name "python*" -ErrorAction SilentlyContinue
            if ($process) {
                Write-Host "  âœ… Python process is RUNNING" -ForegroundColor Green
            } else {
                Write-Host "  âš ï¸ Python process is NOT running" -ForegroundColor Yellow
            }
            
            Write-Host ""
            Write-Host "ðŸ“‹ Next Steps:" -ForegroundColor White
            Write-Host "  1. Open MT4 terminal for account 33627673"
            Write-Host "  2. Compile EA in MetaEditor (if needed)"
            Write-Host "  3. Enable WebRequest: Tools > Options > Expert Advisors"
            Write-Host "     Add URL: http://localhost:8001"
            Write-Host "  4. Attach EA to any chart"
            Write-Host ""
            Write-Host "============================================================" -ForegroundColor Cyan
      
      - name: Post deployment summary
        run: |
          echo "## ðŸš€ VIKING MT4 Bridge Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- \`viking_mt4_bridge_service.py\` - Python bridge service" >> $GITHUB_STEP_SUMMARY
          echo "- \`VIKING_MT4_Bridge.mq4\` - MT4 Expert Advisor" >> $GITHUB_STEP_SUMMARY
          echo "- \`requirements_viking.txt\` - Python dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- **Port:** 8001 (separate from FIDUS on 8000)" >> $GITHUB_STEP_SUMMARY
          echo "- **Account:** 33627673 (VIKING CORE)" >> $GITHUB_STEP_SUMMARY
          echo "- **Collections:** viking_accounts, viking_deals_history" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Steps Required:" >> $GITHUB_STEP_SUMMARY
          echo "1. Compile EA in MetaEditor (if needed)" >> $GITHUB_STEP_SUMMARY
          echo "2. Enable WebRequest for \`http://localhost:8001\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Attach EA to chart on account 33627673" >> $GITHUB_STEP_SUMMARY
