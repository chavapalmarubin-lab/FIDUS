name: Deploy MT4 Bridge - Foolproof

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Deploy Everything to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 600s
          script: |
            powershell.exe -Command "Write-Host '==========================================' -ForegroundColor Cyan; Write-Host 'MT4 BRIDGE DEPLOYMENT' -ForegroundColor Cyan; Write-Host '==========================================' -ForegroundColor Cyan"
            
            powershell.exe -Command "Write-Host 'Step 1: Creating directories...' -ForegroundColor Yellow; New-Item -ItemType Directory -Force -Path 'C:\mt4_bridge_service\logs' | Out-Null; Write-Host 'Done' -ForegroundColor Green"
            
            powershell.exe -Command "Write-Host 'Step 2: Installing Python packages...' -ForegroundColor Yellow; pip install pyzmq pymongo python-dotenv --quiet; Write-Host 'Done' -ForegroundColor Green"
            
            powershell.exe -Command "Write-Host 'Step 3: Creating Python service...' -ForegroundColor Yellow; Set-Content -Path 'C:\mt4_bridge_service\mt4_bridge_api_service.py' -Value 'import zmq
            import json
            import pymongo
            from datetime import datetime, timezone
            import time
            import logging
            import sys
            
            MONGODB_URI = \"mongodb+srv://emergent-ops:BpzaxqxDCjz1yWY4@fidus.ylp9be2.mongodb.net/fidus_production?retryWrites=true&w=majority&appName=FIDUS\"
            MONGODB_DATABASE = \"fidus_production\"
            ZMQ_HOST = \"localhost\"
            ZMQ_PORT = 32768
            
            MT4_ACCOUNT = {
                \"login\": 33200931,
                \"server\": \"MEXAtlantic-Real\",
                \"fund_type\": \"MONEY_MANAGER\",
                \"platform\": \"MT4\"
            }
            
            logging.basicConfig(
                level=logging.INFO,
                format=\"%(asctime)s - %(levelname)s - %(message)s\",
                handlers=[
                    logging.FileHandler(\"C:\\\\mt4_bridge_service\\\\logs\\\\mt4_bridge.log\"),
                    logging.StreamHandler(sys.stdout)
                ]
            )
            logger = logging.getLogger(__name__)
            
            class MT4BridgeService:
                def __init__(self):
                    self.mongo_client = None
                    self.db = None
                    self.collection = None
                    self.context = None
                    self.socket = None
                    
                def connect_mongodb(self):
                    try:
                        logger.info(\"Connecting to MongoDB...\")
                        self.mongo_client = pymongo.MongoClient(MONGODB_URI)
                        self.mongo_client.admin.command(\"ping\")
                        self.db = self.mongo_client[MONGODB_DATABASE]
                        self.collection = self.db[\"mt5_accounts\"]
                        logger.info(\"MongoDB connected successfully\")
                        return True
                    except Exception as e:
                        logger.error(f\"MongoDB connection failed: {e}\")
                        return False
                
                def setup_zeromq(self):
                    try:
                        logger.info(\"Setting up ZeroMQ...\")
                        self.context = zmq.Context()
                        self.socket = self.context.socket(zmq.PULL)
                        address = f\"tcp://{ZMQ_HOST}:{ZMQ_PORT}\"
                        self.socket.bind(address)
                        logger.info(f\"ZeroMQ server bound to {address}\")
                        return True
                    except Exception as e:
                        logger.error(f\"ZeroMQ setup failed: {e}\")
                        return False
                
                def save_account_data(self, data):
                    try:
                        data[\"fund_type\"] = MT4_ACCOUNT[\"fund_type\"]
                        data[\"platform\"] = \"MT4\"
                        data[\"updated_at\"] = datetime.now(timezone.utc).isoformat()
                        data[\"_id\"] = f\"MT4_{MT4_ACCOUNT[\"login\"]}\"
                        
                        self.collection.update_one(
                            {\"account\": MT4_ACCOUNT[\"login\"], \"platform\": \"MT4\"},
                            {\"$set\": data},
                            upsert=True
                        )
                        
                        logger.info(f\"Account {MT4_ACCOUNT[\"login\"]} data saved\")
                        logger.info(f\"Balance: ${data.get(\"balance\", 0):.2f}, Equity: ${data.get(\"equity\", 0):.2f}\")
                        return True
                    except Exception as e:
                        logger.error(f\"Failed to save data: {e}\")
                        return False
                
                def run(self):
                    logger.info(\"=\"*60)
                    logger.info(\"MT4 BRIDGE SERVICE STARTING\")
                    logger.info(\"=\"*60)
                    
                    if not self.connect_mongodb():
                        logger.error(\"Failed to connect to MongoDB. Exiting.\")
                        return
                    
                    if not self.setup_zeromq():
                        logger.error(\"Failed to setup ZeroMQ. Exiting.\")
                        return
                    
                    logger.info(\"MT4 Bridge Service running...\")
                    logger.info(\"Waiting for data from MT4...\")
                    
                    try:
                        while True:
                            try:
                                message = self.socket.recv_string(flags=zmq.NOBLOCK)
                                logger.debug(f\"Received: {message}\")
                                account_data = json.loads(message)
                                self.save_account_data(account_data)
                            except zmq.Again:
                                time.sleep(1)
                            except Exception as e:
                                logger.error(f\"Error processing message: {e}\")
                                time.sleep(1)
                    except KeyboardInterrupt:
                        logger.info(\"Service stopped by user\")
                    except Exception as e:
                        logger.error(f\"Fatal error: {e}\")
                    finally:
                        self.shutdown()
                
                def shutdown(self):
                    logger.info(\"Shutting down...\")
                    if self.socket:
                        self.socket.close()
                    if self.context:
                        self.context.term()
                    if self.mongo_client:
                        self.mongo_client.close()
                    logger.info(\"Service stopped\")
            
            if __name__ == \"__main__\":
                service = MT4BridgeService()
                service.run()
            ' -Encoding UTF8; Write-Host 'Done' -ForegroundColor Green"
            
            powershell.exe -Command "Write-Host 'Step 4: Creating startup BAT...' -ForegroundColor Yellow; Set-Content -Path 'C:\mt4_bridge_service\start_mt4_bridge.bat' -Value '@echo off
            echo ==========================================
            echo MT4 BRIDGE SERVICE STARTING
            echo ==========================================
            cd /d C:\mt4_bridge_service
            python mt4_bridge_api_service.py
            pause'; Write-Host 'Done' -ForegroundColor Green"
            
            powershell.exe -Command "Write-Host 'Step 5: Installing ZeroMQ...' -ForegroundColor Yellow; New-Item -ItemType Directory -Force -Path C:\temp\zmq | Out-Null; Invoke-WebRequest -Uri https://github.com/dingmaotu/mql-zmq/archive/refs/heads/master.zip -OutFile C:\temp\zmq\mql-zmq.zip -UseBasicParsing; Expand-Archive -Path C:\temp\zmq\mql-zmq.zip -DestinationPath C:\temp\zmq -Force; New-Item -ItemType Directory -Force -Path 'C:\Program Files\MEX Atlantic MT4 Terminal\MQL4\Include\Zmq' | Out-Null; Copy-Item -Path 'C:\temp\zmq\mql-zmq-master\MQL4\Include\Zmq\*' -Destination 'C:\Program Files\MEX Atlantic MT4 Terminal\MQL4\Include\Zmq\' -Recurse -Force; Remove-Item C:\temp\zmq -Recurse -Force; Write-Host 'Done' -ForegroundColor Green"
            
            powershell.exe -Command "Write-Host 'Step 6: Creating MT4 EA...' -ForegroundColor Yellow; New-Item -ItemType Directory -Force -Path 'C:\Program Files\MEX Atlantic MT4 Terminal\MQL4\Experts' | Out-Null; Set-Content -Path 'C:\Program Files\MEX Atlantic MT4 Terminal\MQL4\Experts\MT4_Python_Bridge.mq4' -Value '//+------------------------------------------------------------------+
            //|                                          MT4_Python_Bridge.mq4   |
            //+------------------------------------------------------------------+
            #property copyright \"FIDUS Investment Management\"
            #property strict
            
            #include <Zmq/Zmq.mqh>
            
            input int UPDATE_INTERVAL = 300;
            input string ZMQ_HOST = \"localhost\";
            input int ZMQ_PORT = 32768;
            
            datetime lastUpdate = 0;
            Context context(\"MT4_BRIDGE\");
            Socket socket(context, ZMQ_PUSH);
            
            int OnInit() {
                string address = StringFormat(\"tcp://%s:%d\", ZMQ_HOST, ZMQ_PORT);
                socket.connect(address);
                Print(\"MT4 Bridge initialized, connecting to \", address);
                SendAccountData();
                return INIT_SUCCEEDED;
            }
            
            void OnTick() {
                if (TimeCurrent() - lastUpdate >= UPDATE_INTERVAL) {
                    SendAccountData();
                    lastUpdate = TimeCurrent();
                }
            }
            
            void SendAccountData() {
                string json = \"{\";
                json += StringFormat(\"\\\"account\\\": %d,\", AccountNumber());
                json += StringFormat(\"\\\"name\\\": \\\"%s\\\",\", AccountName());
                json += StringFormat(\"\\\"server\\\": \\\"%s\\\",\", AccountServer());
                json += StringFormat(\"\\\"balance\\\": %.2f,\", AccountBalance());
                json += StringFormat(\"\\\"equity\\\": %.2f,\", AccountEquity());
                json += StringFormat(\"\\\"margin\\\": %.2f,\", AccountMargin());
                json += StringFormat(\"\\\"free_margin\\\": %.2f,\", AccountFreeMargin());
                json += StringFormat(\"\\\"profit\\\": %.2f,\", AccountProfit());
                json += StringFormat(\"\\\"currency\\\": \\\"%s\\\",\", AccountCurrency());
                json += StringFormat(\"\\\"leverage\\\": %d,\", AccountLeverage());
                json += StringFormat(\"\\\"credit\\\": %.2f,\", AccountCredit());
                json += StringFormat(\"\\\"platform\\\": \\\"MT4\\\",\");
                json += StringFormat(\"\\\"timestamp\\\": \\\"%s\\\"\", TimeToString(TimeCurrent(), TIME_DATE|TIME_SECONDS));
                json += \"}\";
                
                ZmqMsg message(json);
                socket.send(message);
                Print(\"Account data sent\");
            }
            
            void OnDeinit(const int reason) {
                socket.disconnect(StringFormat(\"tcp://%s:%d\", ZMQ_HOST, ZMQ_PORT));
                Print(\"MT4 Bridge stopped\");
            }' -Encoding UTF8; Write-Host 'Done' -ForegroundColor Green"
            
            powershell.exe -Command "Write-Host '==========================================' -ForegroundColor Cyan; Write-Host 'VERIFICATION' -ForegroundColor Yellow; Write-Host '==========================================' -ForegroundColor Cyan; if (Test-Path 'C:\mt4_bridge_service\mt4_bridge_api_service.py') { Write-Host '[OK] Python service created' -ForegroundColor Green } else { Write-Host '[FAIL] Python service missing' -ForegroundColor Red }; if (Test-Path 'C:\mt4_bridge_service\start_mt4_bridge.bat') { Write-Host '[OK] Startup BAT created' -ForegroundColor Green } else { Write-Host '[FAIL] Startup BAT missing' -ForegroundColor Red }; if (Test-Path 'C:\Program Files\MEX Atlantic MT4 Terminal\MQL4\Experts\MT4_Python_Bridge.mq4') { Write-Host '[OK] MT4 EA created' -ForegroundColor Green } else { Write-Host '[FAIL] MT4 EA missing' -ForegroundColor Red }; if (Test-Path 'C:\Program Files\MEX Atlantic MT4 Terminal\MQL4\Include\Zmq\Zmq.mqh') { Write-Host '[OK] ZeroMQ installed' -ForegroundColor Green } else { Write-Host '[FAIL] ZeroMQ missing' -ForegroundColor Red }"
            
            powershell.exe -Command "Write-Host '==========================================' -ForegroundColor Cyan; Write-Host 'DEPLOYMENT COMPLETE' -ForegroundColor Green; Write-Host '==========================================' -ForegroundColor Cyan; Write-Host 'NEXT STEPS:' -ForegroundColor Yellow; Write-Host '1. Open MT4 Terminal'; Write-Host '2. Press F4 to open MetaEditor'; Write-Host '3. Find MT4_Python_Bridge.mq4'; Write-Host '4. Press F7 to compile'; Write-Host '5. Drag EA onto chart'; Write-Host '6. Enable Allow DLL imports'; Write-Host '7. Start: C:\mt4_bridge_service\start_mt4_bridge.bat'"
            
      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "GITHUB ACTION COMPLETE"
          echo "=========================================="
          echo "Status: ${{ job.status }}"
          echo ""
          echo "Check C:\mt4_bridge_service\ on VPS"
          echo "All files should be created now"
          echo "=========================================="
