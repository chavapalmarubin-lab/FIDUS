name: Add New MT5 Accounts to VPS

on:
  workflow_dispatch:

jobs:
  add-mt5-accounts:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Upload Script to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          source: "vps-scripts/add_new_mt5_accounts.ps1"
          target: "C:/mt5_bridge_service/"
          strip_components: 1
      
      - name: Execute Account Addition Script
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 600s
          command_timeout: 15m
          script: |
            powershell.exe -ExecutionPolicy Bypass -File C:\mt5_bridge_service\add_new_mt5_accounts.ps1
      
      - name: Generate Deployment Report
        if: always()
        run: |
          echo "# New MT5 Accounts Addition Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Accounts Added:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Account | Server | Fund | Manager |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| 897590 | MEXAtlantic-Real | CORE | CP Strategy |" >> $GITHUB_STEP_SUMMARY
          echo "| 897589 | MEXAtlantic-Real | BALANCE | MEXAtlantic Provider 5201 |" >> $GITHUB_STEP_SUMMARY
          echo "| 897591 | MultibankFX-Real | SEPARATION | alefloreztrader |" >> $GITHUB_STEP_SUMMARY
          echo "| 897599 | MultibankFX-Real | SEPARATION | alefloreztrader |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## What Happened:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Downloaded account addition script to VPS" >> $GITHUB_STEP_SUMMARY
          echo "2. Logged into 4 new MT5 accounts using MetaTrader5 Python library" >> $GITHUB_STEP_SUMMARY
          echo "3. Restarted VPS Bridge service" >> $GITHUB_STEP_SUMMARY
          echo "4. Verified all 11 accounts are now in the system" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps (Automatic):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- VPS Bridge will fetch data from MT5 terminals (immediate)" >> $GITHUB_STEP_SUMMARY
          echo "- VPS sync service will update MongoDB (every 5 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "- Backend will pick up new accounts (every 2 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend will display all 11 accounts (real-time)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Verification:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check Render logs for:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "âœ… MT5 sync completed: 11/11 accounts synced successfully" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ETA:** 5-10 minutes for full system sync" >> $GITHUB_STEP_SUMMARY
