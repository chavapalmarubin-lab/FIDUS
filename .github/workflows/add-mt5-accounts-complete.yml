name: Add MT5 Accounts (Complete System-Wide)

on:
  workflow_dispatch:
    inputs:
      accounts:
        description: 'Account numbers to add (comma-separated, e.g., 901351,901353)'
        required: true
        default: '901351,901353'
      password:
        description: 'MT5 Password (default: Fidus13!)'
        required: false
        default: 'Fidus13!'

jobs:
  add-accounts-system-wide:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      # ============================================
      # STEP 1: ADD TO VPS PYTHON BRIDGE SERVICE
      # ============================================
      - name: Add Accounts to VPS Bridge Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            Write-Host "============================================" -ForegroundColor Cyan
            Write-Host "STEP 1: ADD TO VPS BRIDGE SERVICE" -ForegroundColor Cyan
            Write-Host "============================================" -ForegroundColor Cyan
            
            $accounts = "${{ github.event.inputs.accounts }}" -split ','
            $password = "${{ github.event.inputs.password }}"
            $configFile = "C:\mt5_bridge_service\mt5_bridge_service_production.py"
            
            Write-Host "Reading current configuration..." -ForegroundColor Yellow
            $content = Get-Content $configFile -Raw
            
            # Find ACCOUNTS list
            $accountsStart = $content.IndexOf("ACCOUNTS = [")
            $accountsEnd = $content.IndexOf("]", $accountsStart)
            
            if ($accountsStart -eq -1) {
                Write-Host "ERROR: Could not find ACCOUNTS list!" -ForegroundColor Red
                exit 1
            }
            
            Write-Host "Building new account entries..." -ForegroundColor Yellow
            $newEntries = @()
            foreach ($account in $accounts) {
                $account = $account.Trim()
                $entry = @"
                {
                    "login": $account,
                    "password": "$password",
                    "fund_type": "UNASSIGNED",
                    "target_amount": 0,
                    "client_name": "Account $account - Unassigned"
                }
            "@
                $newEntries += $entry
                Write-Host "  + Account $account" -ForegroundColor Green
            }
            
            # Insert new accounts before closing bracket
            $beforeClosing = $content.Substring(0, $accountsEnd)
            $afterClosing = $content.Substring($accountsEnd)
            $updatedContent = $beforeClosing + ",`n" + ($newEntries -join ",`n") + "`n" + $afterClosing
            
            Write-Host "Writing updated configuration..." -ForegroundColor Yellow
            Set-Content $configFile -Value $updatedContent -Encoding UTF8
            
            Write-Host "VPS configuration updated!" -ForegroundColor Green
            Write-Host ""
      
      # ============================================
      # STEP 2: RESTART VPS SERVICE
      # ============================================
      - name: Restart VPS Bridge Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            Write-Host "============================================" -ForegroundColor Cyan
            Write-Host "STEP 2: RESTART VPS SERVICE" -ForegroundColor Cyan
            Write-Host "============================================" -ForegroundColor Cyan
            
            Write-Host "Stopping MT5 Bridge service..." -ForegroundColor Yellow
            try {
                schtasks /End /TN MT5BridgeService 2>$null
                Start-Sleep -Seconds 3
                Write-Host "Service stopped" -ForegroundColor Green
            } catch {
                Write-Host "Service not running" -ForegroundColor Gray
            }
            
            Write-Host "Starting MT5 Bridge service..." -ForegroundColor Yellow
            schtasks /Run /TN MT5BridgeService
            Start-Sleep -Seconds 10
            Write-Host "Service started" -ForegroundColor Green
            Write-Host ""
      
      # ============================================
      # STEP 3: VERIFY VPS SYNC
      # ============================================
      - name: Verify VPS Accounts
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            Write-Host "============================================" -ForegroundColor Cyan
            Write-Host "VERIFICATION: VPS ACCOUNTS" -ForegroundColor Cyan
            Write-Host "============================================" -ForegroundColor Cyan
            
            Start-Sleep -Seconds 5
            
            try {
                $summary = Invoke-RestMethod -Uri "http://localhost:8000/api/mt5/accounts/summary" -Method Get -TimeoutSec 15
                $total = $summary.accounts.Count
                
                Write-Host "Total accounts in VPS: $total" -ForegroundColor White
                
                if ($total -eq 13) {
                    Write-Host "SUCCESS: All 13 accounts syncing!" -ForegroundColor Green
                } else {
                    Write-Host "WARNING: Expected 13, found $total" -ForegroundColor Yellow
                }
                
                Write-Host "`nAccount Details:" -ForegroundColor Cyan
                foreach ($acc in $summary.accounts) {
                    Write-Host "  - $($acc.account): $($acc.fund_type)" -ForegroundColor White
                }
            } catch {
                Write-Host "Could not verify via API: $_" -ForegroundColor Yellow
            }
            Write-Host ""
      
      # ============================================
      # STEP 4: ADD TO MONGODB
      # ============================================
      - name: Add Accounts to MongoDB
        run: |
          echo "============================================"
          echo "STEP 4: ADD TO MONGODB"
          echo "============================================"
          
          # Install pymongo
          pip install pymongo
          
          # Create Python script
          cat > add_to_mongo.py << 'PYTHON_SCRIPT'
          from pymongo import MongoClient
          from datetime import datetime, timezone
          import sys
          
          accounts_input = "${{ github.event.inputs.accounts }}"
          password = "${{ github.event.inputs.password }}"
          
          # Parse account numbers
          account_numbers = [int(acc.strip()) for acc in accounts_input.split(',')]
          
          # Connect to MongoDB
          mongo_uri = "mongodb+srv://emergent-ops:BpzaxqxDCjz1yWY4@fidus.y1p9be2.mongodb.net/fidus_production"
          client = MongoClient(mongo_uri)
          db = client.fidus_production
          
          print(f"Adding {len(account_numbers)} accounts to MongoDB...")
          
          for account_num in account_numbers:
              # Check if exists
              existing = db.mt5_account_config.find_one({"account": account_num})
              
              if existing:
                  print(f"  ⚠️  Account {account_num} already exists, updating...")
                  db.mt5_account_config.update_one(
                      {"account": account_num},
                      {"$set": {
                          "password": password,
                          "is_active": True,
                          "status": "unassigned",
                          "updated_at": datetime.now(timezone.utc)
                      }}
                  )
              else:
                  print(f"  ✅ Adding account {account_num}...")
                  db.mt5_account_config.insert_one({
                      'account': account_num,
                      'password': password,
                      'name': f'Account {account_num}',
                      'fund_type': None,
                      'manager': None,
                      'broker': 'MEXAtlantic',
                      'server': 'MEXAtlantic-Real',
                      'target_amount': 0,
                      'is_active': True,
                      'status': 'unassigned',
                      'created_at': datetime.now(timezone.utc),
                      'updated_at': datetime.now(timezone.utc)
                  })
          
          # Verify
          total = db.mt5_account_config.count_documents({"is_active": True})
          print(f"\n✅ MongoDB now has {total} active accounts")
          
          client.close()
          PYTHON_SCRIPT
          
          # Run script
          python add_to_mongo.py
      
      # ============================================
      # STEP 5: UPDATE BACKEND SERVER.PY
      # ============================================
      - name: Update Backend Configuration
        run: |
          echo "============================================"
          echo "STEP 5: UPDATE BACKEND SERVER.PY"
          echo "============================================"
          
          # Create Python script to update server.py
          cat > update_backend.py << 'PYTHON_SCRIPT'
          import re
          import sys
          
          accounts_input = "${{ github.event.inputs.accounts }}"
          password = "${{ github.event.inputs.password }}"
          
          # Parse account numbers
          account_numbers = [int(acc.strip()) for acc in accounts_input.split(',')]
          
          print("Reading backend/server.py...")
          with open('backend/server.py', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Find MT5_ACCOUNTS list
          pattern = r'MT5_ACCOUNTS\s*=\s*\[(.*?)\]'
          match = re.search(pattern, content, re.DOTALL)
          
          if not match:
              print("ERROR: Could not find MT5_ACCOUNTS list!")
              sys.exit(1)
          
          accounts_section = match.group(0)
          
          # Build new account entries
          new_entries = []
          for account_num in account_numbers:
              entry = f'''    {{
                  "account_number": {account_num},
                  "password": "{password}",
                  "broker": "MEXAtlantic",
                  "server": "MEXAtlantic-Real",
                  "fund_type": None,
                  "manager": None,
                  "is_active": True,
                  "status": "unassigned"
              }}'''
              new_entries.append(entry)
              print(f"  + Account {account_num}")
          
          # Insert before closing bracket
          updated_section = accounts_section[:-1] + ',\n' + ',\n'.join(new_entries) + '\n]'
          
          # Replace in content
          updated_content = content.replace(accounts_section, updated_section)
          
          print("Writing updated server.py...")
          with open('backend/server.py', 'w', encoding='utf-8') as f:
              f.write(updated_content)
          
          print("✅ Backend configuration updated!")
          PYTHON_SCRIPT
          
          # Run script
          python update_backend.py
      
      # ============================================
      # STEP 6: COMMIT AND PUSH CHANGES
      # ============================================
      - name: Commit Backend Changes
        run: |
          echo "============================================"
          echo "STEP 6: COMMIT CHANGES TO GITHUB"
          echo "============================================"
          
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          git add backend/server.py
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add MT5 accounts: ${{ github.event.inputs.accounts }}"
            git push
            echo "✅ Changes pushed to GitHub (Render will auto-deploy)"
          fi
      
      # ============================================
      # STEP 7: GENERATE REPORT
      # ============================================
      - name: Generate Deployment Report
        if: always()
        run: |
          echo "# MT5 Accounts Addition Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Accounts Added:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Account | Password | Broker | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          IFS=',' read -ra ACCOUNTS <<< "${{ github.event.inputs.accounts }}"
          for account in "${ACCOUNTS[@]}"; do
            account=$(echo $account | xargs)
            echo "| $account | Fidus13! | MEXAtlantic | Unassigned |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Locations Updated:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **VPS Bridge Service** - Python configuration file" >> $GITHUB_STEP_SUMMARY
          echo "✅ **MongoDB Atlas** - mt5_account_config collection" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Backend API** - server.py MT5_ACCOUNTS list" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Wait 3 minutes** for Render to auto-deploy backend changes" >> $GITHUB_STEP_SUMMARY
          echo "2. **Check VPS logs:** Should show \`✅ VPS sync complete: 13/13 accounts synced\`" >> $GITHUB_STEP_SUMMARY
          echo "3. **Check Backend logs:** Should show \`✅ Accounts sync complete: 13/13 accounts synced\`" >> $GITHUB_STEP_SUMMARY
          echo "4. **Check Investment Committee UI:** Should show 2 new unassigned accounts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Verification URLs:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Logs: https://dashboard.render.com/web/srv-csd5gna3esus73assh5g/logs" >> $GITHUB_STEP_SUMMARY
          echo "- Investment Committee: https://alloc-refresh.preview.emergentagent.com" >> $GITHUB_STEP_SUMMARY
