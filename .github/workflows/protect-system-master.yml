name: Protect Critical Documentation Files

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run every hour to check file existence
    - cron: '0 * * * *'

jobs:
  check-system-master:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history

      - name: Check if critical files exist
        id: check-files
        run: |
          MISSING_FILES=""
          
          if [ ! -f "SYSTEM_MASTER.md" ]; then
            echo "‚ùå CRITICAL: SYSTEM_MASTER.md is MISSING!"
            MISSING_FILES="SYSTEM_MASTER.md "
          else
            echo "‚úÖ SYSTEM_MASTER.md exists"
          fi
          
          if [ ! -f "DATABASE_FIELD_STANDARDS.md" ]; then
            echo "‚ùå CRITICAL: DATABASE_FIELD_STANDARDS.md is MISSING!"
            MISSING_FILES="${MISSING_FILES}DATABASE_FIELD_STANDARDS.md"
          else
            echo "‚úÖ DATABASE_FIELD_STANDARDS.md exists"
          fi
          
          if [ -n "$MISSING_FILES" ]; then
            echo "files_missing=true" >> $GITHUB_OUTPUT
            echo "missing_list=$MISSING_FILES" >> $GITHUB_OUTPUT
          else
            echo "files_missing=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if file was deleted in this commit
        if: steps.check-file.outputs.file_exists == 'false'
        run: |
          echo "Checking last commit..."
          git log -1 --name-status
          echo ""
          echo "üö® SYSTEM_MASTER.md WAS DELETED OR NEVER ADDED!"
          echo "This is a CRITICAL violation."
          
          # Check if file ever existed
          if git log --all --diff-filter=A --name-only -- "SYSTEM_MASTER.md" | grep -q "SYSTEM_MASTER.md"; then
            echo "File was previously added and has been DELETED"
            exit 1
          else
            echo "‚ö†Ô∏è  WARNING: File has never been added to repository"
            echo "Please create SYSTEM_MASTER.md and commit it"
          fi

      - name: Attempt to restore file if deleted
        if: steps.check-file.outputs.file_exists == 'false'
        continue-on-error: true
        run: |
          echo "Attempting to restore SYSTEM_MASTER.md from history..."
          
          # Try to restore from previous commit
          if git checkout HEAD~1 -- SYSTEM_MASTER.md 2>/dev/null; then
            echo "‚úÖ File restored from previous commit"
            git config user.name "GitHub Action - File Protection"
            git config user.email "action@github.com"
            git add SYSTEM_MASTER.md
            git commit -m "üö® AUTO-RESTORE: SYSTEM_MASTER.md was deleted - restoring from backup"
            git push
          else
            echo "‚ùå Could not restore file - it may have never existed in git history"
            echo "Please manually create and commit SYSTEM_MASTER.md"
          fi

      - name: Create issue if file missing
        if: steps.check-file.outputs.file_exists == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® CRITICAL: SYSTEM_MASTER.md is missing',
              body: `## Critical File Missing
              
              **File:** SYSTEM_MASTER.md
              **Status:** MISSING
              **Commit:** ${{ github.sha }}
              **Time:** ${new Date().toISOString()}
              
              ### Action Required:
              1. Create SYSTEM_MASTER.md with proper documentation
              2. Commit and push the file
              3. Verify file protection is working
              
              ### Context:
              The codebase references this file in multiple locations but it does not exist in the repository.
              
              **Referenced in:**
              - backend/validation/field_registry.py
              - backend/server.py (Section 4.1)
              
              This file is CRITICAL for system operation and must be restored immediately.`,
              labels: ['critical', 'documentation', 'bug']
            })
