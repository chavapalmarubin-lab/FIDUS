name: MT5 Bridge Emergency Restart (HTTP API)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for restart'
        required: false
        default: 'Auto-healing triggered by watchdog'
  repository_dispatch:
    types: [mt5-bridge-restart]

jobs:
  emergency-restart:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Trigger Emergency Restart via HTTP API
        run: |
          echo "üö® MT5 Bridge Emergency Restart Initiated"
          echo "=========================================="
          echo "Reason: ${{ github.event.inputs.reason || 'Auto-healing triggered by watchdog' }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "VPS: 92.118.45.135:8000"
          echo "=========================================="
          echo ""
          
          echo "üì° Calling emergency restart endpoint..."
          response=$(curl -X POST \
            "http://92.118.45.135:8000/api/admin/emergency-restart?token=${{ secrets.ADMIN_SECRET_TOKEN }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo ""
          echo "üìä Response Details:"
          echo "HTTP Status: $http_code"
          echo "Response Body: $body"
          echo ""
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Emergency restart successful!"
            echo "$body" | grep -q '"success":true' && echo "‚úÖ MT5 reinitialized successfully"
            echo "$body" | grep -q '"mongodb_connected":true' && echo "‚úÖ MongoDB connection verified"
            exit 0
          elif [ "$http_code" -eq 401 ]; then
            echo "‚ùå Authentication failed!"
            echo "‚ö†Ô∏è  Check ADMIN_SECRET_TOKEN in GitHub secrets"
            echo "‚ö†Ô∏è  Verify token matches VPS .env configuration"
            exit 1
          elif [ "$http_code" -eq 404 ]; then
            echo "‚ùå Emergency restart endpoint not found!"
            echo "‚ö†Ô∏è  Check VPS deployment status"
            echo "‚ö†Ô∏è  Verify mt5_bridge_api_service.py is running"
            exit 1
          else
            echo "‚ùå Unexpected response - HTTP $http_code"
            echo "‚ö†Ô∏è  Check VPS service logs for details"
            exit 1
          fi
      
      - name: Verify Service Recovery
        run: |
          echo ""
          echo "=========================================="
          echo "üîç Verifying Service Recovery"
          echo "=========================================="
          echo "Waiting 10 seconds for service stabilization..."
          sleep 10
          
          echo "üì° Performing health check..."
          health=$(curl -s http://92.118.45.135:8000/api/mt5/bridge/health)
          
          echo ""
          echo "üìä Health Check Response:"
          echo "$health" | python3 -m json.tool || echo "$health"
          echo ""
          
          if echo "$health" | grep -q '"status":"healthy"'; then
            echo "‚úÖ‚úÖ‚úÖ SERVICE IS HEALTHY ‚úÖ‚úÖ‚úÖ"
            echo "‚úÖ MT5 Bridge is operational"
            echo "‚úÖ Auto-healing completed successfully"
            echo "=========================================="
            exit 0
          else
            echo "‚ö†Ô∏è Service may need additional recovery time"
            echo "‚ö†Ô∏è Check service logs if issues persist"
            echo "=========================================="
            exit 1
          fi
      
      - name: Report Final Status
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìã Emergency Restart Summary"
          echo "=========================================="
          echo "Trigger: ${{ github.event.inputs.reason || 'Auto-healing' }}"
          echo "Completed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "VPS Service: http://92.118.45.135:8000"
          echo "Health Check: http://92.118.45.135:8000/api/mt5/bridge/health"
          echo "=========================================="
