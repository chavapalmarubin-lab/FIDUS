name: Deploy MT4 Bridge - Automated

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy MT4 Expert Advisor to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        script: |
          $base64Content = "Ly8rLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKwovL3wgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNVDRfUHl0aG9uX0JyaWRnZS5tcTQgICB8Ci8vKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKI3Byb3BlcnR5IGNvcHlyaWdodCAiRklEVVMgSW52ZXN0bWVudCBNYW5hZ2VtZW50IgojcHJvcGVydHkgc3RyaWN0CgojaW5jbHVkZSA8Wm1xL1ptcS5tcWg+CgppbnB1dCBpbnQgVVBEQVRFX0lOVEVSVkFMID0gMzAwOwppbnB1dCBzdHJpbmcgWk1RX0hPU1QgPSAibG9jYWxob3N0IjsKaW5wdXQgaW50IFpNUV9QT1JUID0gMzI3Njg7CgpkYXRldGltZSBsYXN0VXBkYXRlID0gMDsKQ29udGV4dCBjb250ZXh0KCJNVDRfQlJJREdFIik7ClNvY2tldCBzb2NrZXQoY29udGV4dCwgWk1RX1BVU0gpOwoKaW50IE9uSW5pdCgpIHsKICAgIHN0cmluZyBhZGRyZXNzID0gInRjcDovLyIgKyBaTVFfSE9TVCArICI6IiArIEludGVnZXJUb1N0cmluZyhaTVFfUE9SVCk7CiAgICBzb2NrZXQuY29ubmVjdChhZGRyZXNzKTsKICAgIFByaW50KCJNVDQgQnJpZGdlIGluaXRpYWxpemVkLCBjb25uZWN0aW5nIHRvICIsIGFkZHJlc3MpOwogICAgU2VuZEFjY291bnREYXRhKCk7CiAgICByZXR1cm4gSU5JVF9TVUNDRUVERUQ7Cn0KCnZvaWQgT25UaWNrKCkgewogICAgaWYgKFRpbWVDdXJyZW50KCkgLSBsYXN0VXBkYXRlID49IFVQREFURV9JTlRFUlZBTCkgewogICAgICAgIFNlbmRBY2NvdW50RGF0YSgpOwogICAgICAgIGxhc3RVcGRhdGUgPSBUaW1lQ3VycmVudCgpOwogICAgfQp9Cgp2b2lkIFNlbmRBY2NvdW50RGF0YSgpIHsKICAgIHN0cmluZyBxID0gQ2hhclRvU3RyaW5nKDM0KTsKICAgIHN0cmluZyBqc29uID0gInsiOwogICAganNvbiA9IGpzb24gKyBxICsgImFjY291bnQiICsgcSArICI6IiArIEludGVnZXJUb1N0cmluZyhBY2NvdW50TnVtYmVyKCkpICsgIiwiOwogICAganNvbiA9IGpzb24gKyBxICsgIm5hbWUiICsgcSArICI6IiArIHEgKyBBY2NvdW50TmFtZSgpICsgcSArICIsIjsKICAgIGpzb24gPSBqc29uICsgcSArICJzZXJ2ZXIiICsgcSArICI6IiArIHEgKyBBY2NvdW50U2VydmVyKCkgKyBxICsgIiwiOwogICAganNvbiA9IGpzb24gKyBxICsgImJhbGFuY2UiICsgcSArICI6IiArIERvdWJsZVRvU3RyaW5nKEFjY291bnRCYWxhbmNlKCksIDIpICsgIiwiOwogICAganNvbiA9IGpzb24gKyBxICsgImVxdWl0eSIgKyBxICsgIjoiICsgRG91YmxlVG9TdHJpbmcoQWNjb3VudEVxdWl0eSgpLCAyKSArICIsIjsKICAgIGpzb24gPSBqc29uICsgcSArICJtYXJnaW4iICsgcSArICI6IiArIERvdWJsZVRvU3RyaW5nKEFjY291bnRNYXJnaW4oKSwgMikgKyAiLCI7CiAgICBqc29uID0ganNvbiArIHEgKyAiZnJlZV9tYXJnaW4iICsgcSArICI6IiArIERvdWJsZVRvU3RyaW5nKEFjY291bnRGcmVlTWFyZ2luKCksIDIpICsgIiwiOwogICAganNvbiA9IGpzb24gKyBxICsgInByb2ZpdCIgKyBxICsgIjoiICsgRG91YmxlVG9TdHJpbmcoQWNjb3VudFByb2ZpdCgpLCAyKSArICIsIjsKICAgIGpzb24gPSBqc29uICsgcSArICJjdXJyZW5jeSIgKyBxICsgIjoiICsgcSArIEFjY291bnRDdXJyZW5jeSgpICsgcSArICIsIjsKICAgIGpzb24gPSBqc29uICsgcSArICJsZXZlcmFnZSIgKyBxICsgIjoiICsgSW50ZWdlclRvU3RyaW5nKEFjY291bnRMZXZlcmFnZSgpKSArICIsIjsKICAgIGpzb24gPSBqc29uICsgcSArICJjcmVkaXQiICsgcSArICI6IiArIERvdWJsZVRvU3RyaW5nKEFjY291bnRDcmVkaXQoKSwgMikgKyAiLCI7CiAgICBqc29uID0ganNvbiArIHEgKyAicGxhdGZvcm0iICsgcSArICI6IiArIHEgKyAiTVQ0IiArIHEgKyAiLCI7CiAgICBqc29uID0ganNvbiArIHEgKyAidGltZXN0YW1wIiArIHEgKyAiOiIgKyBxICsgVGltZVRvU3RyaW5nKFRpbWVDdXJyZW50KCksIFRJTUVfREFURXxUSU1FX1NFQ09ORFMpICsgcTsKICAgIGpzb24gPSBqc29uICsgIn0iOwogICAgCiAgICBabXFNc2cgbXNnKGpzb24pOwogICAgc29ja2V0LnNlbmQobXNnKTsKICAgIFByaW50KCJBY2NvdW50IGRhdGEgc2VudCAtIEJhbGFuY2U6ICIsIEFjY291bnRCYWxhbmNlKCksICIsIEVxdWl0eTogIiwgQWNjb3VudEVxdWl0eSgpKTsKfQoKdm9pZCBPbkRlaW5pdChjb25zdCBpbnQgcmVhc29uKSB7CiAgICBzdHJpbmcgYWRkcmVzcyA9ICJ0Y3A6Ly8iICsgWk1RX0hPU1QgKyAiOiIgKyBJbnRlZ2VyVG9TdHJpbmcoWk1RX1BPUlQpOwogICAgc29ja2V0LmRpc2Nvbm5lY3QoYWRkcmVzcyk7CiAgICBQcmludCgiTVQ0IEJyaWRnZSBzdG9wcGVkIik7Cn0K"
          $targetPath = "C:\Program Files\MEX Atlantic MT4 Terminal\MQL4\Experts\MT4_Python_Bridge.mq4"
          $bytes = [System.Convert]::FromBase64String($base64Content)
          $content = [System.Text.Encoding]::UTF8.GetString($bytes)
          [System.IO.File]::WriteAllText($targetPath, $content)
          Write-Host "MT4 Expert Advisor deployed successfully to: $targetPath"
          Write-Host "File size: $((Get-Item $targetPath).Length) bytes"
