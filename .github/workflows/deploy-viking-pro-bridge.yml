# ============================================================
# VIKING PRO MT4 Bridge Deployment Workflow
# ============================================================
# Deploys VIKING PRO bridge to C:\viking_bridge (same as CORE)
# Account: 1309411 | Strategy: PRO | Broker: Traders Trust
# ============================================================

name: Deploy VIKING PRO MT4 Bridge

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'full_deploy'
        type: choice
        options:
          - full_deploy
          - restart_service
          - check_status
          - view_logs

jobs:
  deploy-viking-pro:
    runs-on: ubuntu-latest
    name: VIKING PRO (${{ github.event.inputs.action }})
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ============================================================
      # FULL DEPLOYMENT
      # ============================================================
      - name: Full Deploy - Download and Setup
        if: ${{ github.event.inputs.action == 'full_deploy' }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 180s
          command_timeout: 300s
          script: |
            Write-Host "============================================" -ForegroundColor Cyan
            Write-Host "VIKING PRO Bridge Deployment" -ForegroundColor Cyan
            Write-Host "Account: 1309411 | Traders Trust" -ForegroundColor Cyan
            Write-Host "============================================" -ForegroundColor Cyan
            
            $bridgePath = "C:\viking_bridge"
            
            # Ensure directory exists
            if (-not (Test-Path $bridgePath)) {
                New-Item -ItemType Directory -Path $bridgePath -Force | Out-Null
                Write-Host "Created: $bridgePath" -ForegroundColor Green
            }
            
            # Download files from GitHub
            Write-Host "Downloading files..." -ForegroundColor Cyan
            $repo = "${{ github.repository }}"
            $branch = "${{ github.ref_name }}"
            $baseUrl = "https://raw.githubusercontent.com/$repo/$branch/vps-scripts"
            
            Invoke-WebRequest -Uri "$baseUrl/viking_pro_file_monitor.py" -OutFile "$bridgePath\viking_pro_file_monitor.py" -UseBasicParsing
            Write-Host "  Downloaded: viking_pro_file_monitor.py" -ForegroundColor Gray
            
            Invoke-WebRequest -Uri "$baseUrl/start_viking_pro_monitor.bat" -OutFile "$bridgePath\start_viking_pro_monitor.bat" -UseBasicParsing
            Write-Host "  Downloaded: start_viking_pro_monitor.bat" -ForegroundColor Gray
            
            Write-Host "Files downloaded" -ForegroundColor Green
            
            # List files
            Get-ChildItem $bridgePath -Filter "*pro*" | Format-Table Name, Length

      - name: Full Deploy - Create Scheduled Task
        if: ${{ github.event.inputs.action == 'full_deploy' }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 60s
          script: |
            $taskName = "VIKING_PRO_File_Monitor"
            $bridgePath = "C:\viking_bridge"
            
            # Remove existing task if present
            $existing = Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
            if ($existing) {
                Unregister-ScheduledTask -TaskName $taskName -Confirm:$false
                Write-Host "Removed existing task" -ForegroundColor Yellow
            }
            
            # Create new task
            $action = New-ScheduledTaskAction -Execute "python" -Argument "$bridgePath\viking_pro_file_monitor.py" -WorkingDirectory $bridgePath
            $trigger = New-ScheduledTaskTrigger -AtStartup
            $settings = New-ScheduledTaskSettingsSet -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)
            
            Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Settings $settings -User "SYSTEM" -RunLevel Highest
            
            Write-Host "Created scheduled task: $taskName" -ForegroundColor Green

      - name: Full Deploy - Start Service
        if: ${{ github.event.inputs.action == 'full_deploy' }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 60s
          script: |
            Write-Host "Starting VIKING PRO service..." -ForegroundColor Cyan
            
            Start-ScheduledTask -TaskName "VIKING_PRO_File_Monitor"
            Start-Sleep -Seconds 3
            
            $task = Get-ScheduledTask -TaskName "VIKING_PRO_File_Monitor"
            Write-Host "Task State: $($task.State)" -ForegroundColor Green
            
            Write-Host ""
            Write-Host "============================================" -ForegroundColor Green
            Write-Host "DEPLOYMENT COMPLETE" -ForegroundColor Green
            Write-Host "============================================" -ForegroundColor Green

      # ============================================================
      # RESTART SERVICE
      # ============================================================
      - name: Restart Service
        if: ${{ github.event.inputs.action == 'restart_service' }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 60s
          script: |
            Stop-ScheduledTask -TaskName "VIKING_PRO_File_Monitor" -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2
            Start-ScheduledTask -TaskName "VIKING_PRO_File_Monitor"
            Start-Sleep -Seconds 3
            
            $task = Get-ScheduledTask -TaskName "VIKING_PRO_File_Monitor"
            Write-Host "Task State: $($task.State)" -ForegroundColor Green

      # ============================================================
      # CHECK STATUS
      # ============================================================
      - name: Check Status
        if: ${{ github.event.inputs.action == 'check_status' }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 60s
          script: |
            Write-Host "VIKING PRO Status Check" -ForegroundColor Cyan
            Write-Host "========================" -ForegroundColor Cyan
            
            # Check task
            $task = Get-ScheduledTask -TaskName "VIKING_PRO_File_Monitor" -ErrorAction SilentlyContinue
            if ($task) {
                Write-Host "Scheduled Task: $($task.State)" -ForegroundColor Green
            } else {
                Write-Host "Scheduled Task: NOT FOUND" -ForegroundColor Red
            }
            
            # Check JSON file
            $jsonFile = "C:\Users\Administrator\AppData\Roaming\MetaQuotes\Terminal\Common\Files\viking_account_1309411_data.json"
            if (Test-Path $jsonFile) {
                $fileInfo = Get-Item $jsonFile
                Write-Host "JSON File: EXISTS" -ForegroundColor Green
                Write-Host "  Last Modified: $($fileInfo.LastWriteTime)" -ForegroundColor Gray
            } else {
                Write-Host "JSON File: NOT FOUND (EA not running?)" -ForegroundColor Yellow
            }
            
            # List PRO files
            Write-Host ""
            Write-Host "PRO Files in C:\viking_bridge:" -ForegroundColor Cyan
            Get-ChildItem "C:\viking_bridge" -Filter "*pro*" | Format-Table Name, Length

      # ============================================================
      # VIEW LOGS
      # ============================================================
      - name: View Logs
        if: ${{ github.event.inputs.action == 'view_logs' }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 60s
          script: |
            Write-Host "VIKING PRO Logs" -ForegroundColor Cyan
            
            # Check if JSON exists and show content
            $jsonFile = "C:\Users\Administrator\AppData\Roaming\MetaQuotes\Terminal\Common\Files\viking_account_1309411_data.json"
            if (Test-Path $jsonFile) {
                Write-Host "JSON Content:" -ForegroundColor Cyan
                Get-Content $jsonFile | ConvertFrom-Json | Format-List
            } else {
                Write-Host "No JSON file found" -ForegroundColor Yellow
            }

      - name: Summary
        run: |
          echo "## VIKING PRO Bridge - ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Account | 1309411 |" >> $GITHUB_STEP_SUMMARY
          echo "| Strategy | PRO |" >> $GITHUB_STEP_SUMMARY
          echo "| Broker | Traders Trust |" >> $GITHUB_STEP_SUMMARY
          echo "| Directory | C:\\viking_bridge |" >> $GITHUB_STEP_SUMMARY
          echo "| Task Name | VIKING_PRO_File_Monitor |" >> $GITHUB_STEP_SUMMARY

      # ============================================================
      # DIAGNOSE SYNC ISSUE
      # ============================================================
      - name: Diagnose Sync Issue
        if: ${{ github.event.inputs.action == 'diagnose' }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 120s
          script: |
            Write-Host "========================================" -ForegroundColor Cyan
            Write-Host "VIKING PRO SYNC DIAGNOSTICS" -ForegroundColor Cyan
            Write-Host "========================================" -ForegroundColor Cyan
            
            # 1. Check scheduled task
            Write-Host "`n1. SCHEDULED TASK STATUS:" -ForegroundColor Yellow
            $task = Get-ScheduledTask -TaskName "VIKING_PRO_File_Monitor" -ErrorAction SilentlyContinue
            if ($task) {
                Write-Host "   State: $($task.State)" -ForegroundColor $(if ($task.State -eq 'Running') { 'Green' } else { 'Red' })
                $taskInfo = Get-ScheduledTaskInfo -TaskName "VIKING_PRO_File_Monitor"
                Write-Host "   Last Run: $($taskInfo.LastRunTime)" -ForegroundColor Gray
                Write-Host "   Last Result: $($taskInfo.LastTaskResult)" -ForegroundColor Gray
            } else {
                Write-Host "   Task NOT FOUND!" -ForegroundColor Red
            }
            
            # 2. Check JSON file
            Write-Host "`n2. JSON FILE STATUS:" -ForegroundColor Yellow
            $jsonPath = "C:\Users\Administrator\AppData\Roaming\MetaQuotes\Terminal\Common\Files\viking_account_1309411_data.json"
            if (Test-Path $jsonPath) {
                $file = Get-Item $jsonPath
                Write-Host "   Path: $jsonPath" -ForegroundColor Green
                Write-Host "   Size: $($file.Length) bytes" -ForegroundColor Gray
                Write-Host "   Last Modified: $($file.LastWriteTime)" -ForegroundColor Gray
                Write-Host "`n   Content Preview:" -ForegroundColor Cyan
                $content = Get-Content $jsonPath | ConvertFrom-Json
                Write-Host "   Account: $($content.account)"
                Write-Host "   Balance: $($content.balance)"
                Write-Host "   Equity: $($content.equity)"
                Write-Host "   Timestamp: $($content.timestamp)"
            } else {
                Write-Host "   FILE NOT FOUND!" -ForegroundColor Red
            }
            
            # 3. Check Python files
            Write-Host "`n3. PYTHON FILES:" -ForegroundColor Yellow
            $pyFile = "C:\viking_bridge\viking_pro_file_monitor.py"
            if (Test-Path $pyFile) {
                $py = Get-Item $pyFile
                Write-Host "   $pyFile" -ForegroundColor Green
                Write-Host "   Size: $($py.Length) bytes, Modified: $($py.LastWriteTime)" -ForegroundColor Gray
            } else {
                Write-Host "   Python file NOT FOUND!" -ForegroundColor Red
            }
            
            # 4. Check Python processes
            Write-Host "`n4. PYTHON PROCESSES:" -ForegroundColor Yellow
            Get-Process python* -ErrorAction SilentlyContinue | ForEach-Object {
                $cmdLine = (Get-CimInstance Win32_Process -Filter "ProcessId = $($_.Id)").CommandLine
                Write-Host "   PID $($_.Id): $cmdLine" -ForegroundColor Gray
            }
            
            # 5. Try to restart
            Write-Host "`n5. RESTARTING SERVICE..." -ForegroundColor Yellow
            Stop-ScheduledTask -TaskName "VIKING_PRO_File_Monitor" -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2
            Start-ScheduledTask -TaskName "VIKING_PRO_File_Monitor"
            Start-Sleep -Seconds 5
            
            $task = Get-ScheduledTask -TaskName "VIKING_PRO_File_Monitor"
            Write-Host "   New State: $($task.State)" -ForegroundColor $(if ($task.State -eq 'Running') { 'Green' } else { 'Red' })
            
            Write-Host "`n========================================" -ForegroundColor Cyan
            Write-Host "DIAGNOSTICS COMPLETE" -ForegroundColor Cyan
            Write-Host "========================================" -ForegroundColor Cyan
