name: Sync LUCRUM Accounts to MongoDB

on:
  workflow_dispatch:

jobs:
  sync-lucrum:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Set MEXAtlantic to Zero
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            Write-Host "=== Setting MEXAtlantic Accounts to Zero ===" -ForegroundColor Cyan
            Write-Host ""
            
            @"
from pymongo import MongoClient
from datetime import datetime, timezone

client = MongoClient('${{ secrets.MONGO_URL }}', serverSelectionTimeoutMS=10000)
db = client['fidus_production']

# LUCRUM accounts to keep active
lucrum_accounts = [2199, 2205, 2206, 2207, 2208, 2209, 20042, 20043, 20067]

# Set all non-LUCRUM accounts to zero and inactive
print('Setting non-LUCRUM accounts to zero...')
result = db.mt5_accounts.update_many(
    {'account': {'`$nin': lucrum_accounts}},
    {'`$set': {
        'balance': 0,
        'equity': 0,
        'status': 'inactive',
        'updated_at': datetime.now(timezone.utc)
    }}
)
print(f'Updated {result.modified_count} accounts to zero')

# Verify final state
print()
print('=== VERIFICATION ===')
active = list(db.mt5_accounts.find({'status': 'active'}))
total = sum(float(a.get('balance', 0) or 0) for a in active)
print(f'Active accounts: {len(active)}')
print(f'Total Balance: `${total:,.2f}')

print()
print('Active account details:')
for acc in sorted(active, key=lambda x: -float(x.get('balance', 0) or 0)):
    print(f"  - {acc.get('account')}: `${float(acc.get('balance', 0)):,.2f}")

client.close()
print()
print('Done!')
"@ | python -
      
      - name: Verify MT5 Bridge Status
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            Write-Host ""
            Write-Host "=== MT5 Bridge Status ===" -ForegroundColor Cyan
            Write-Host ""
            
            try {
              $response = Invoke-RestMethod -Uri "http://localhost:8000/api/mt5/accounts/summary" -Method Get -TimeoutSec 10
              Write-Host "MT5 Bridge is running with $($response.accounts.Count) accounts" -ForegroundColor Green
              
              $lucrum = @(2199, 2205, 2206, 2207, 2208, 2209, 20042, 20043, 20067)
              Write-Host ""
              Write-Host "LUCRUM accounts from MT5 Bridge:" -ForegroundColor Cyan
              foreach ($acc in $response.accounts) {
                if ($lucrum -contains $acc.account) {
                  Write-Host "  Account $($acc.account): Balance = $($acc.balance)" -ForegroundColor Green
                }
              }
            } catch {
              Write-Host "MT5 Bridge not responding" -ForegroundColor Yellow
            }
      
      - name: Generate Report
        if: always()
        run: |
          echo "# LUCRUM Account Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Set all non-LUCRUM (MEXAtlantic) accounts to zero and inactive." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**LUCRUM Accounts:**" >> $GITHUB_STEP_SUMMARY
          echo "- 2199, 2205, 2206, 2207, 2208, 2209, 20042, 20043, 20067" >> $GITHUB_STEP_SUMMARY
