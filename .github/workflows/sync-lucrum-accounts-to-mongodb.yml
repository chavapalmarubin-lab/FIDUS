name: Sync LUCRUM Accounts to MongoDB

on:
  workflow_dispatch:

jobs:
  sync-lucrum:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install pymongo requests
      
      - name: Fetch MT5 Data and Update MongoDB
        env:
          MONGO_URL: ${{ secrets.MONGO_URL }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          python3 << 'EOF'
          import os
          import requests
          from pymongo import MongoClient
          from datetime import datetime, timezone
          
          MONGO_URL = os.environ.get('MONGO_URL')
          VPS_HOST = os.environ.get('VPS_HOST', '92.118.45.135')
          
          print("=" * 60)
          print("LUCRUM ACCOUNT SYNC TO MONGODB")
          print("=" * 60)
          print()
          
          # Connect to MongoDB
          print("Connecting to MongoDB...")
          client = MongoClient(MONGO_URL, serverSelectionTimeoutMS=10000)
          db = client['fidus_production']
          print("✅ Connected to MongoDB")
          
          # Try to fetch from VPS MT5 Bridge
          print()
          print(f"Fetching data from MT5 Bridge at {VPS_HOST}:8000...")
          
          mt5_accounts_data = []
          try:
              response = requests.get(f"http://{VPS_HOST}:8000/api/mt5/accounts/summary", timeout=30)
              if response.status_code == 200:
                  mt5_data = response.json()
                  mt5_accounts_data = mt5_data.get('accounts', [])
                  print(f"✅ Got {len(mt5_accounts_data)} accounts from MT5 Bridge")
              else:
                  print(f"⚠️ MT5 Bridge returned status {response.status_code}")
          except Exception as e:
              print(f"⚠️ Could not reach MT5 Bridge: {e}")
              print("   Will set non-LUCRUM accounts to $0 based on database records")
          
          # Define LUCRUM accounts
          lucrum_accounts = [2199, 2205, 2206, 2207, 2208, 2209, 20042, 20043, 20067]
          
          # 1. Set ALL non-LUCRUM accounts to $0 and inactive
          print()
          print("Setting non-LUCRUM accounts to $0 and inactive...")
          result = db.mt5_accounts.update_many(
              {'account': {'$nin': lucrum_accounts}},
              {'$set': {
                  'balance': 0,
                  'equity': 0,
                  'status': 'inactive',
                  'updated_at': datetime.now(timezone.utc)
              }}
          )
          print(f"  Updated {result.modified_count} non-LUCRUM accounts to $0")
          
          # 2. Update LUCRUM accounts if we have MT5 data
          if mt5_accounts_data:
              print()
              print("Updating LUCRUM accounts with MT5 Bridge data...")
              for acc_data in mt5_accounts_data:
                  acc_num = acc_data.get('account')
                  if acc_num in lucrum_accounts:
                      balance = float(acc_data.get('balance', 0) or 0)
                      equity = float(acc_data.get('equity', 0) or 0)
                      status = 'active' if balance > 0 else 'inactive'
                      
                      db.mt5_accounts.update_one(
                          {'account': acc_num},
                          {'$set': {
                              'balance': balance,
                              'equity': equity,
                              'status': status,
                              'broker': 'LUCRUM Capital',
                              'last_sync_timestamp': datetime.now(timezone.utc),
                              'updated_at': datetime.now(timezone.utc)
                          }},
                          upsert=True
                      )
                      indicator = '✅' if status == 'active' else '⚪'
                      print(f"  {indicator} Account {acc_num}: Balance=${balance:,.2f}, Equity=${equity:,.2f}")
          
          # 3. Verify final state
          print()
          print("=" * 60)
          print("FINAL VERIFICATION")
          print("=" * 60)
          
          active = list(db.mt5_accounts.find({'status': 'active'}))
          total_balance = sum(float(a.get('balance', 0) or 0) for a in active)
          total_equity = sum(float(a.get('equity', 0) or 0) for a in active)
          
          print(f"Active accounts: {len(active)}")
          print(f"Total Balance: ${total_balance:,.2f}")
          print(f"Total Equity: ${total_equity:,.2f}")
          
          print()
          print("Active account details:")
          for acc in sorted(active, key=lambda x: -float(x.get('balance', 0) or 0)):
              print(f"  - {acc.get('account')}: ${float(acc.get('balance', 0)):,.2f} ({acc.get('manager_name', 'Unknown')})")
          
          # Check for any MEXAtlantic accounts with balance > 0
          mex_with_balance = list(db.mt5_accounts.find({
              'broker': {'$in': ['MEXAtlantic', 'MEX Atlantic']},
              'balance': {'$gt': 0}
          }))
          
          if mex_with_balance:
              print()
              print("⚠️ WARNING: Found MEXAtlantic accounts with balance > 0:")
              for acc in mex_with_balance:
                  print(f"  - {acc.get('account')}: ${float(acc.get('balance', 0)):,.2f}")
          else:
              print()
              print("✅ All MEXAtlantic accounts have $0 balance")
          
          client.close()
          print()
          print("✅ Sync complete!")
          EOF
      
      - name: Generate Sync Report
        if: always()
        run: |
          echo "# LUCRUM Account Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Sync Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## What Was Done:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Connected to MongoDB fidus_production database" >> $GITHUB_STEP_SUMMARY
          echo "2. Attempted to fetch live data from MT5 Bridge" >> $GITHUB_STEP_SUMMARY
          echo "3. Set all non-LUCRUM accounts to \$0 and inactive" >> $GITHUB_STEP_SUMMARY
          echo "4. Updated LUCRUM accounts with MT5 data (if available)" >> $GITHUB_STEP_SUMMARY
          echo "5. Verified final MongoDB state" >> $GITHUB_STEP_SUMMARY
