name: Sync LUCRUM Accounts to MongoDB

on:
  workflow_dispatch:

jobs:
  sync-lucrum:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Sync LUCRUM Accounts via VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            Write-Host "=== LUCRUM Account Sync to MongoDB ===" -ForegroundColor Cyan
            Write-Host ""
            
            # First, get data from MT5 Bridge API
            Write-Host "Fetching data from MT5 Bridge API..." -ForegroundColor Yellow
            try {
              $response = Invoke-RestMethod -Uri "http://localhost:8000/api/mt5/accounts/summary" -Method Get -TimeoutSec 30
              $accounts = $response.accounts
              Write-Host "Got $($accounts.Count) accounts from MT5 Bridge" -ForegroundColor Green
              
              # Show LUCRUM accounts
              Write-Host ""
              Write-Host "LUCRUM Account Balances from MT5:" -ForegroundColor Cyan
              $lucrumAccounts = @(2199, 2205, 2206, 2207, 2208, 2209, 20042, 20043, 20067)
              foreach ($acc in $accounts) {
                if ($lucrumAccounts -contains $acc.account) {
                  Write-Host "  Account $($acc.account): Balance = $($acc.balance), Equity = $($acc.equity)" -ForegroundColor Green
                }
              }
            } catch {
              Write-Host "Error fetching MT5 data: $_" -ForegroundColor Red
              $accounts = @()
            }
            
            # Now update MongoDB using Python
            Write-Host ""
            Write-Host "Updating MongoDB..." -ForegroundColor Yellow
            
            $mongoUrl = (Get-Content "C:\mt5_bridge_service\config.json" | ConvertFrom-Json).mongodb_url
            
            $pythonScript = @"
import json
from pymongo import MongoClient
from datetime import datetime, timezone

mongo_url = '$mongoUrl'
print(f'Connecting to MongoDB...')
client = MongoClient(mongo_url, serverSelectionTimeoutMS=10000)
db = client['fidus_production']
print('Connected!')

lucrum_accounts = [2199, 2205, 2206, 2207, 2208, 2209, 20042, 20043, 20067]

# Set all non-LUCRUM accounts to 0 and inactive
print()
print('Setting non-LUCRUM accounts to 0...')
result = db.mt5_accounts.update_many(
    {'account': {'\$nin': lucrum_accounts}},
    {'\$set': {
        'balance': 0,
        'equity': 0,
        'status': 'inactive',
        'updated_at': datetime.now(timezone.utc)
    }}
)
print(f'  Updated {result.modified_count} non-LUCRUM accounts')

# Verify
print()
print('=== VERIFICATION ===')
active = list(db.mt5_accounts.find({'status': 'active'}))
total_balance = sum(float(a.get('balance', 0) or 0) for a in active)
print(f'Active accounts: {len(active)}')
print(f'Total Balance: \${total_balance:,.2f}')

for acc in sorted(active, key=lambda x: -float(x.get('balance', 0) or 0)):
    print(f"  - {acc.get('account')}: \${float(acc.get('balance', 0)):,.2f}")

client.close()
print()
print('Sync complete!')
"@
            
            $pythonScript | python -
      
      - name: Generate Report
        if: always()
        run: |
          echo "# LUCRUM Account Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow syncs LUCRUM account data from the MT5 Bridge to MongoDB." >> $GITHUB_STEP_SUMMARY
