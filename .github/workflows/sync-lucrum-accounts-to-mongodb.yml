name: Sync LUCRUM Accounts to MongoDB

on:
  workflow_dispatch:

jobs:
  sync-lucrum:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Set MEXAtlantic to Zero via VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            Write-Host "=== LUCRUM Account Sync ===" -ForegroundColor Cyan
            
            Write-Host "Checking MT5 Bridge..." -ForegroundColor Yellow
            try {
              $response = Invoke-RestMethod -Uri "http://localhost:8000/api/mt5/accounts/summary" -Method Get -TimeoutSec 30
              Write-Host "Got $($response.accounts.Count) accounts" -ForegroundColor Green
            } catch {
              Write-Host "MT5 Bridge error: $_" -ForegroundColor Red
            }
            
            Write-Host ""
            Write-Host "Running MongoDB sync script..." -ForegroundColor Yellow
            
            cd C:\mt5_bridge_service
            python -c "
            from pymongo import MongoClient
            from datetime import datetime, timezone
            import json
            
            with open('config.json') as f:
                config = json.load(f)
            
            client = MongoClient(config['mongodb_url'])
            db = client['fidus_production']
            
            lucrum = [2199, 2205, 2206, 2207, 2208, 2209, 20042, 20043, 20067]
            
            result = db.mt5_accounts.update_many(
                {'account': {chr(36)+'nin': lucrum}},
                {chr(36)+'set': {'balance': 0, 'equity': 0, 'status': 'inactive', 'updated_at': datetime.now(timezone.utc)}}
            )
            print(f'Updated {result.modified_count} non-LUCRUM accounts to zero')
            
            active = list(db.mt5_accounts.find({'status': 'active'}))
            total = sum(float(a.get('balance', 0) or 0) for a in active)
            print(f'Active: {len(active)} accounts, Total: chr(36){total:,.2f}')
            
            client.close()
            "
      
      - name: Report
        if: always()
        run: echo "Sync complete" >> $GITHUB_STEP_SUMMARY
