# FIDUS MT5 Integration - Complete Setup Guide

## üéØ Overview
This guide provides step-by-step instructions to set up MT5 integration using a single automated PowerShell script.

## üìã Prerequisites
- Windows VPS access (ForexVPS.net or similar)
- MT5 trading account with broker
- FIDUS backend running on Kubernetes

---

## üöÄ PART 1: VPS Setup (Automated)

### Step 1: Download Setup Script
The complete setup script is located at:
```
/app/mt5_bridge_service/setup_mt5_bridge.ps1
```

### Step 2: Upload to VPS
1. **Resolve VPS Access Issues**:
   - Contact ForexVPS.net support if RDP not working
   - Verify credentials: `chavapalmarubin@gmail.com` / `2170Tenoch!`
   - Try different RDP clients (Windows RDP, Microsoft Remote Desktop for Mac)

2. **Upload Script**:
   - Copy `setup_mt5_bridge.ps1` to VPS desktop
   - Alternative: Use VPS file manager or web interface if available

### Step 3: Run Automated Setup
```powershell
# Right-click setup_mt5_bridge.ps1 ‚Üí Run with PowerShell
# OR open PowerShell as Administrator and run:
cd C:\Users\chavapalmarubin@gmail.com\Desktop
.\setup_mt5_bridge.ps1
```

### What the Script Does:
‚úÖ **Checks Python Installation** (installs guidance if needed)  
‚úÖ **Creates Directory Structure** (`C:\mt5_bridge_service\`)  
‚úÖ **Creates All Service Files** (main_production.py, requirements.txt, etc.)  
‚úÖ **Installs Dependencies** (FastAPI, MetaTrader5, etc.)  
‚úÖ **Generates Security Keys** (API key, encryption key)  
‚úÖ **Creates Configuration** (.env file with placeholders)  
‚úÖ **Sets Up Firewall Rules** (opens port 8000)  
‚úÖ **Creates Management Scripts** (start, stop, test service)  

### Step 4: Configure MT5 Credentials
After script completes, edit `C:\mt5_bridge_service\.env`:

```env
# Generated by script (DO NOT CHANGE):
MT5_BRIDGE_API_KEY=FIDUS-MT5-PROD-123456-20251004
MT5_ENCRYPTION_KEY=RklEVVMtTVQ1LUVOQy1LRVktMTIzNDU2LTIwMjUxMDA0

# CONFIGURE THESE (IMPORTANT!):
MT5_DEFAULT_ACCOUNT=123456
MT5_DEFAULT_PASSWORD=your_mt5_password  
MT5_DEFAULT_SERVER=YourBroker-Demo
```

### Step 5: Install MetaTrader 5 Terminal
1. Download MT5 from your broker's website
2. Install and login with your trading account  
3. **Keep MT5 running** - the bridge service needs it active

### Step 6: Test the Service
```cmd
# Run test script:
C:\mt5_bridge_service\test_service.bat

# Expected output:
‚úÖ Core dependencies OK
‚úÖ MetaTrader5 package OK  
‚úÖ Service can start successfully
```

### Step 7: Start the Service
```cmd
# Start the bridge service:
C:\mt5_bridge_service\start_service.bat

# Service should start on port 8000
# Keep this window open or install as Windows service
```

### Step 8: Verify Service Health
Open browser on VPS: `http://localhost:8000/health`

Expected response:
```json
{
  "status": "healthy",
  "mt5_available": true,
  "mt5_initialized": true,
  "mt5_connected": true,
  "timestamp": "2025-01-04T..."
}
```

---

## üîó PART 2: FIDUS Backend Configuration

### Step 1: Update Backend Configuration
Run the configuration script:
```bash
cd /app/backend
python3 scripts/update_mt5_config.py
```

**Script will prompt for:**
- VPS IP Address (default: 217.197.163.11)
- MT5 Bridge API Key (from VPS .env file)
- MT5 Encryption Key (from VPS .env file)  
- Connection Timeout (default: 30)

### Step 2: Manual Configuration (Alternative)
Edit `/app/backend/.env` directly:
```env
# MT5 Bridge Service Configuration
MT5_BRIDGE_URL=http://217.197.163.11:8000
MT5_BRIDGE_API_KEY=FIDUS-MT5-PROD-123456-20251004
MT5_BRIDGE_TIMEOUT=30  
MT5_ENCRYPTION_KEY=RklEVVMtTVQ1LUVOQy1LRVktMTIzNDU2LTIwMjUxMDA0
```

**‚ö†Ô∏è IMPORTANT**: Use the EXACT keys generated by the VPS setup script!

### Step 3: Restart Backend Service
```bash
sudo supervisorctl restart backend
```

### Step 4: Verify Backend Health
```bash
curl -s http://localhost:8001/api/health | jq .
```

---

## üß™ PART 3: Integration Testing

### Test 1: Backend Health Check
```bash
# Should show MT5 service initialized
curl http://localhost:8001/api/health
```

### Test 2: MT5 Bridge Connectivity
From FIDUS backend, test bridge connection:
```bash
# This requires authentication - use admin token
curl -H "Authorization: Bearer <admin_token>" \
     -H "Content-Type: application/json" \
     http://localhost:8001/api/mt5/bridge/health
```

### Test 3: MT5 Account Connection
1. **Login to FIDUS Admin Panel**
2. **Navigate to MT5 Management**  
3. **Click "Test MT5 Connection"**
4. **Enter MT5 Credentials:**
   - Account: Your MT5 account number
   - Password: Your MT5 password  
   - Server: Your broker server
5. **Verify Success Response**

### Test 4: Create MT5 Account Link
1. **In FIDUS Admin Panel**
2. **Go to Client Management**
3. **Select a Client** 
4. **Click "Add MT5 Account"**
5. **Enter MT5 Details:**
   - Account: 123456
   - Broker: multibank (or your broker)
   - Server: YourBroker-Demo
   - Fund: CORE (or desired fund)
6. **Verify Account Creation**

### Test 5: Real-Time Data Sync
1. **Create MT5 Account Link** (from Test 4)
2. **Manual Sync**: Click "Sync Account Data"
3. **Verify Data**: Check balance, equity, positions
4. **Background Sync**: Wait 5 minutes, check auto-update

---

## üìä PART 4: Monitoring & Management

### VPS Service Management
```cmd
# On Windows VPS:
C:\mt5_bridge_service\start_service.bat   # Start service
C:\mt5_bridge_service\stop_service.bat    # Stop service  
C:\mt5_bridge_service\test_service.bat    # Test setup

# View logs:
C:\mt5_bridge_service\logs\
```

### FIDUS Backend Monitoring
```bash
# Check MT5 service status
curl -H "Authorization: Bearer <admin_token>" \
     http://localhost:8001/api/mt5/status

# Manual sync all accounts  
curl -X POST -H "Authorization: Bearer <admin_token>" \
     http://localhost:8001/api/mt5/sync-all

# Get client MT5 accounts
curl -H "Authorization: Bearer <admin_token>" \
     http://localhost:8001/api/mt5/accounts/<client_id>
```

### Health Endpoints
| Endpoint | Purpose | Authentication |
|----------|---------|---------------|
| `VPS:8000/health` | Bridge service health | None |
| `VPS:8000/` | Bridge service info | None |  
| `FIDUS/api/health` | Backend health | None |
| `FIDUS/api/mt5/bridge/health` | Bridge connectivity | Admin token |
| `FIDUS/api/mt5/status` | Full MT5 system status | Admin token |

---

## üîß PART 5: Troubleshooting

### Common Issues & Solutions

**üî¥ VPS Setup Script Fails**
```
‚ùå Python not found in PATH
‚úÖ Install Python 3.11+ from python.org (check "Add to PATH")

‚ùå Access denied creating directory  
‚úÖ Run PowerShell as Administrator

‚ùå MetaTrader5 import fails
‚úÖ Install MT5 terminal first, then re-run script
```

**üî¥ Service Won't Start**
```
‚ùå "Address already in use" 
‚úÖ Stop existing service: taskkill /f /im python.exe
‚úÖ Change port in .env: PORT=8001

‚ùå MT5 initialization failed
‚úÖ Ensure MT5 terminal is running and logged in
‚úÖ Check MT5 credentials in .env file
```

**üî¥ FIDUS Backend Connection Issues**
```
‚ùå "Connection refused"
‚úÖ Check VPS firewall (port 8000 open)
‚úÖ Verify service running: netstat -an | findstr :8000
‚úÖ Test from VPS: curl http://localhost:8000/health

‚ùå "Invalid API key"  
‚úÖ Ensure same API key in both VPS and FIDUS .env files
‚úÖ Restart FIDUS backend after updating .env

‚ùå "MT5 Bridge service not available"
‚úÖ Check VPS service is running
‚úÖ Verify network connectivity between FIDUS and VPS
```

**üî¥ MT5 Authentication Fails**
```
‚ùå "Login failed" with correct credentials
‚úÖ Verify MT5 terminal is logged in to same account
‚úÖ Check server name matches exactly (case sensitive)
‚úÖ Try demo account first to test connectivity

‚ùå "MT5 not connected" 
‚úÖ Restart MT5 terminal
‚úÖ Check broker server status
‚úÖ Verify account is not locked/suspended
```

### Log Locations
| Service | Log Location | Purpose |
|---------|--------------|---------|
| VPS Setup | `C:\mt5_bridge_service\setup.log` | Installation logs |
| Bridge Service | `C:\mt5_bridge_service\logs\` | Runtime logs |
| FIDUS Backend | `/var/log/supervisor/backend.*.log` | Backend logs |

### Network Testing
```cmd
# On VPS - Test port is open:
netstat -an | findstr :8000

# Test external access (from FIDUS server):
telnet 217.197.163.11 8000

# Test HTTP connectivity:
curl -v http://217.197.163.11:8000/health
```

---

## üîê PART 6: Security Best Practices

### Generated Keys
- **API Key**: 32+ character random string
- **Encryption Key**: Base64 encoded random bytes  
- **Regeneration**: Run setup script again or manual generation

### Network Security
```cmd
# Windows Firewall (VPS):
# Rule: Allow TCP 8000 inbound
# Scope: Limit to FIDUS backend IP if possible

# Consider HTTPS:
# Use reverse proxy (nginx) with SSL certificate
# Update FIDUS backend URL to https://
```

### Key Management
```env
# Rotate keys periodically:
# 1. Generate new keys on VPS
# 2. Update FIDUS backend .env  
# 3. Restart both services
# 4. Test connectivity

# Backup configuration:
# Save .env files securely
# Document MT5 account mapping
```

---

## üìà PART 7: Production Deployment

### Performance Optimization
```env
# VPS .env optimizations:
LOG_LEVEL=warning  # Reduce log verbosity
PORT=8000         # Standard port
ENVIRONMENT=prod  # Production mode
```

### Monitoring Setup
1. **Windows Service Installation** (optional):
   - Use NSSM (Non-Sucking Service Manager)  
   - Auto-restart on failure
   - Service logs to Windows Event Log

2. **Health Check Automation**:
   - Windows Task Scheduler for health checks
   - Email alerts on service failure
   - Automated restart scripts

3. **Performance Monitoring**:
   - Track sync success rates
   - Monitor API response times  
   - Alert on MT5 connection failures

### Backup Strategy
```cmd
# Backup these files regularly:
C:\mt5_bridge_service\.env           # Configuration
C:\mt5_bridge_service\logs\          # Service logs  
C:\mt5_bridge_service\setup.log      # Installation log

# FIDUS backend:
/app/backend/.env                    # Configuration
/var/log/supervisor/backend.*.log    # Runtime logs
```

---

## üéâ SUCCESS CHECKLIST

**‚úÖ VPS Setup Complete:**
- [ ] PowerShell script ran successfully  
- [ ] MT5 terminal installed and running
- [ ] Bridge service starts without errors
- [ ] Health endpoint responds correctly
- [ ] Windows firewall configured

**‚úÖ FIDUS Backend Configured:**
- [ ] .env file updated with VPS keys
- [ ] Backend service restarted successfully
- [ ] MT5 endpoints respond with authentication  
- [ ] Bridge connectivity confirmed

**‚úÖ Integration Working:**
- [ ] MT5 connection test passes in admin panel
- [ ] Can create MT5 account links
- [ ] Real-time data sync working
- [ ] Account balances update correctly
- [ ] Positions and trades sync

**‚úÖ Production Ready:**
- [ ] All security keys generated and secured
- [ ] Network connectivity stable
- [ ] Monitoring and alerting configured
- [ ] Backup procedures documented
- [ ] Team trained on management procedures

---

## üÜò Support Resources

**Documentation:**
- Setup script: `/app/mt5_bridge_service/setup_mt5_bridge.ps1`
- Backend config: `/app/backend/scripts/update_mt5_config.py`  
- This guide: `/app/MT5_INTEGRATION_SETUP_GUIDE.md`

**Test Scripts:**
- VPS health: `C:\mt5_bridge_service\test_service.bat`
- Backend integration: `/app/backend/scripts/test_mt5_integration.py`

**Key Files:**
- VPS config: `C:\mt5_bridge_service\.env`
- FIDUS config: `/app/backend/.env`
- Service logs: `C:\mt5_bridge_service\logs\`

---

**Setup Date**: January 4, 2025  
**Version**: 1.0.0  
**Status**: Production Ready ‚úÖ