<analysis>**original_problem_statement:**
The user's initial goal was to fix the Investment Committee UI, which was broken in production due to authentication and CORS errors. After the agent fixed the authentication issue, the user requested a major redesign of the Investment Committee page, including:
1.  A new layout with 5 fund type categories at the top.
2.  Removal of the Brokers section.
3.  A confirmation dialog for reassigning accounts.
4.  An Apply Changes button to trigger backend recalculations.
5.  A sticky header for the fund types and a search bar for the MT5 account list.

After several iterations on the UI, the user introduced a new, high-priority feature: **Create an MT4 Python Bridge**. This new service must replicate the existing MT5 bridge architecture for a new MT4 account (33200931), which requires a different technical approach (ZeroMQ + Expert Advisor) since MT4 lacks a direct Python API. The data must be stored in the same MongoDB collection as the existing 13 MT5 accounts, adhering to strict field naming standards.

**PRODUCT REQUIREMENTS:**
1.  **Implement MT4 Bridge (P0):** Create a complete, production-ready MT4 bridge service for account 33200931. This includes an MQL4 Expert Advisor, a Python service using ZeroMQ, and integration with the existing database and deployment workflows.
2.  **Fix Investment Committee UI Bugs (P1):** Resolve the outstanding bugs from the recent redesign:
    *   Fix Invalid fund type error on drag-and-drop.
    *   Restore the total capital summary display.
    *   Implement the final Apply Allocations workflow, including validation and triggering backend recalculations.
3.  **Fix Referral Logins (P2):** Fix the logins for three referral agents (, , ). This is a carry-over issue from the previous session.

**User's preferred language**: English

**what currently exists?**
*   **Frontend:** The Investment Committee tab is now loading data after a critical authentication fix (correcting the  key for the JWT token). It has been significantly redesigned with a new 5-fund-type layout, search bar, and sticky header. However, this new UI has functional bugs related to drag-and-drop actions and data display.
*   **Backend:** The API endpoints for the investment committee workflow exist. The code has been updated to dynamically handle both MT5 and MT4 accounts by querying the database instead of using hardcoded lists.
*   **MT4 Bridge:** The initial files for the new MT4 bridge have been created (, , , ). However, the Python service contains critical bugs.

**Last working item**:
*   **Last item agent was working:** The agent was reviewing the newly created Python service for the MT4 bridge () against very specific documentation provided by the user. It discovered that the service was using incorrect field names (e.g.,  instead of ), violating the strict data standards.
*   **Status:** IN PROGRESS
*   **Agent Testing Done:** N
*   **Which testing method agent to use?** backend testing agent. The agent should first fix the code, then create a test to run the Python script, and verify that the data is correctly written to the MongoDB database with the proper field names.
*   **User Testing Done:** N

**All Pending/In progress Issue list**:
*   **Issue 1: Incorrect Field Names in MT4 Bridge Service (P0 - CRITICAL BLOCKER)**
*   **Issue 2: Functional Bugs in Redesigned Investment Committee UI (P1)**
*   **Issue 3: Three Referral Agent Logins are Failing (P2)**

**Issues Detail:**
*   **Issue 1: Incorrect Field Names in MT4 Bridge Service (P0 - CRITICAL BLOCKER)**
    *   **Attempted fixes:** This issue was just discovered by the agent while reviewing its own code against user-provided documentation. No fix has been attempted yet.
    *   **Next debug checklist:**
        1.  Open .
        2.  Locate the  function.
        3.  Correct all field names in the dictionary being saved to MongoDB to match the Python MetaTrader5 API standard (e.g., change  to ,  to ,  to ).
        4.  Ensure the  operation with  is used to prevent duplicates.
    *   **Why fix this issue and what will be achieved with the fix?** This is critical for data consistency. If not fixed, the MT4 account data will be incompatible with the backend and frontend, breaking all related features. Fixing it is a mandatory step in the MT4 bridge implementation.
    *   **Status:** IN PROGRESS
    *   **Is recurring issue?** N
    *   **Should Test frontend/backend/both after fix?** Backend.
    *   **Blocked on other issue:** No. This is blocking the MT4 task.

*   **Issue 2: Functional Bugs in Redesigned Investment Committee UI (P1)**
    *   **Attempted fixes:** The agent created the new UI but has not yet fixed the bugs reported by the user in Message 220.
    *   **Next debug checklist:**
        1.  **Invalid fund type error:** In , ensure the  value sent to the backend on drop exactly matches the backend's expected values (e.g., FIDUS CORE, SEPARATION INTEREST).
        2.  **Missing Total Capital:** In , re-implement the logic to calculate and display the sum of balances of all unassigned MT5 accounts.
        3.  **Apply Button Logic:** Implement validation logic for the Apply Allocations button. It should be disabled until the total allocated capital matches the total available MT5 capital. The  handler should open the .
    *   **Why fix this issue and what will be achieved with the fix?** This will make the primary Investment Committee workflow functional and usable for the user.
    *   **Status:** NOT STARTED
    *   **Is recurring issue?** N
    *   **Should Test frontend/backend/both after fix?** Both.
    *   **Blocked on other issue:** No.

*   **Issue 3: Three Referral Agent Logins are Failing (P2)**
    *   **Attempted fixes:** Previous agent failed after multiple attempts due to a misunderstanding of the auth schema. No new attempts in this session.
    *   **Next debug checklist:**
        1.  Examine a known working  account in the  collection to find the correct schema.
        2.  Update the three target accounts (, etc.) to match the correct schema.
        3.  Test login via .
    *   **Why fix this issue and what will be achieved with the fix?** This is a long-standing user request required for user management.
    *   **Status:** NOT STARTED
    *   **Is recurring issue?** Y
    *   **Should Test backend/both after fix?** Backend.
    *   **Blocked on other issue:** No.

**In progress Task List**:
*   **Task 1: Implement MT4 Bridge (P0)**
    *   **Where to resume:** The immediate next step is to fix the incorrect field names in  as detailed in **Issue 1**. After that, proceed with the full implementation plan provided by the user (testing the EA, the Python service, and the full data flow).
    *   **What will be achieved with this?** A new MT4 account will be integrated into the FIDUS platform, feeding live data into the system alongside the existing 13 MT5 accounts.
    *   **Status:** IN PROGRESS
    *   **Should Test frontend/backend/both after fix?** Both.
    *   **Blocked on something:** Blocked on **Issue 1**.

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   **Task 1 (P1):** Complete End-to-End Feature Testing of the Investment Committee workflow after all UI bugs are fixed. This includes testing validation states and verifying all 6 backend recalculations run correctly.
*   **Future Tasks:**
    *   **Task 2 (P2):** Code Cleanup: Remove all obsolete V1 code for the Investment Committee feature.
    *   **Task 3 (P2):** Implement Referral Link Analytics Backend.
    *   **Task 4 (P2):** Platform-wide Refactoring: Replace all instances of MultiBank with MEXAtlantic.

**Completed work in this session**
*   **Investment Committee Authentication Fix:**
    *   Identified and fixed the root cause of the production UI failure: the frontend was using the wrong  key ( instead of ) to retrieve the JWT token.
*   **Investment Committee POST Request Fix:**
    *   Fixed drag-and-drop errors by adding the  header to the  utility function.
*   **Major UI Redesign of Investment Committee Page:**
    *   Replaced the old layout with a new 5-fund-type horizontal layout at the top.
    *   Removed the Brokers section as requested.
    *   Added a confirmation dialog for reassigning accounts.
    *   Implemented a sticky/frozen top panel for the fund types.
    *   Added a search bar to the unassigned MT5 accounts list.
*   **MT4 Bridge Implementation (Initial Phase):**
    *   Created the foundational files for the MT4 bridge: , , , and a GitHub Actions workflow.
    *   Updated backend routes to dynamically handle both MT4 and MT5 accounts.

**Earlier issues found/mentioned but not fixed**
*   **Issue 1: Three Referral Agent Logins are Failing:** This was a P1 issue from the previous handoff that was de-prioritized to focus on the Investment Committee UI and the new MT4 bridge request. It remains unresolved.

**Known issue recurrence from previous fork**
*   None.

**Code Architecture**


**Key Technical Concepts**
*   **Frameworks**: React, FastAPI
*   **Database**: MongoDB Atlas
*   **UI Technology**: 
*   **Deployment**: Backend/Frontend on Render.com, MT5/MT4 Bridge Service on a separate VPS.
*   **Authentication**: JWT-based.
*   **Trading Platform Integration**:
    *   **MT5:** Direct Python API ( library).
    *   **MT4:** Indirect bridge via **MQL4 Expert Advisor** and **ZeroMQ (ZMQ)** sockets.

**key DB schema**
*   ****: . The correct schema for  is still unconfirmed.
*   ****: . This collection now stores data for both MT5 and MT4 accounts, distinguished by the  field.

**changes in tech stack**
*   Introduction of **MQL4** and **ZeroMQ (ZMQ)** for the MT4 bridge integration.

**All files**
*   **Created:**
    *   : New UI for the 5 fund types.
    *   : Confirmation for re-assigning an account.
    *   : Final confirmation dialog before triggering backend actions.
    *   : The MQL4 Expert Advisor for the MT4 terminal.
    *   : The Python service that listens to the EA via ZMQ.
    *   : Setup script for the VPS.
    *   : GitHub Actions workflow for the new service.
*   **Updated:**
    *   : Major overhaul to implement the new design and logic.
    *   : Added search bar and total capital summary.
    *   : Fixed auth token key and added  to headers.
    *   : Removed hardcoded account lists to dynamically support MT4 and MT5 from the database.
    *   : Added styles for the redesigned layout, search, and sticky header.

**Areas that need refactoring**:
*   None identified in this session.

**key api endpoints**
*   : Triggers the 6 backend recalculations. Needs to be connected to the new UI.
*   : Used for drag-and-drop actions.
*   : Endpoint for user login.

**Critical Info for New Agent**
*   **Follow User Specs Exactly:** The user is highly technical and provides extremely detailed specifications and documentation excerpts (e.g., for the MT4 bridge). These are the absolute source of truth and must be followed precisely. Do not deviate.
*   **Field Naming is Non-Negotiable:** All data fields for MT4/MT5 accounts in the database **must** match the official Python  API naming convention (e.g., , not ). The agent was about to make this mistake.
*   **Test and Verify Independently:** The user's frustration from the previous session was due to the agent not testing its own fixes. You are expected to verify all backend and frontend changes yourself before presenting them as complete.
*   **MT4 vs. MT5 Architecture:** Understand the fundamental difference. MT5 uses a direct Python library. The new MT4 bridge requires a multi-part solution involving an MQL4 Expert Advisor and a ZeroMQ socket bridge to a Python service.

**documents created in this job**
*   
*   
*   
*   
*   

**Last 5 User Messages and any pending user messages**
1.  **User (Message 257):** Submitted a very detailed specification for creating a new MT4 bridge from scratch, including technical architecture, code snippets, and deployment plans. **Status: In Progress.**
2.  **Agent (Message 279):** Confirmed understanding of the MT4 spec but noted it couldn't access external documentation files, requesting either the doc contents or permission to proceed based on the spec alone. **Status: Completed.**
3.  **User (Message 280):** Provided the agent with detailed excerpts from the system documentation (, etc.) as requested, emphasizing critical rules and data standards. **Status: Completed.**
4.  **Agent (Message 281):** Sent a formal confirmation acknowledging receipt and understanding of the documentation excerpts, and stated it was ready to begin implementation. **Status: Completed.**
5.  **Agent (Message 287):** While reviewing its own new code against the provided docs, the agent found a critical bug (incorrect field names in the Python service) and stated its intent to fix it. **Status: This is the current state.**

**Project Health Check:**
*   **Broken**: The Investment Committee UI has new functional bugs. The Referral Agent login is still broken. The newly created MT4 Bridge service code is buggy.
*   **Mocked**: Referral Link Analytics on the profile page still use placeholder data.

**Testing status**
*   **Testing agent used after significant changes**: NO
*   **Troubleshoot agent used after agent stuck in loop**: NO
*   **Test files created**: None.
*   **Known regressions**: The redesigned Investment Committee UI introduced new bugs (invalid fund type, missing totals).

**Credentials to test flow:**
*   **Admin:**  /  (Note: username is , not an email)
*   **Referral Agents (to be fixed):**
    *    / 
    *    / 
    *    / 

**What agent forgot to execute**
*   **Fix Referral Agent Logins:** This P1 issue from the original handoff was never addressed in this session and remains pending.</analysis>
