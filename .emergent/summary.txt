<analysis>**original_problem_statement:**
The user's initial goal was to fix a broken production financial dashboard and address data inconsistencies. This has evolved into a mandate for a comprehensive platform refactor to enforce a Single Source of Truth (SSOT) architecture, fix all broken tabs, and add new data allocations.

The user is extremely frustrated with the platform's state, providing detailed bug reports, screenshots, and specifications for fixes. The main goals are to ensure data integrity and correct UI representation across all dashboard tabs.

**User's Current Explicit Demands:**
1.  **FIX ALL TABS:** The agent must fix all remaining broken tabs, ensuring data is accurate and consistent.
    *   **Investments Tab (CRITICAL):** Currently shows a Failed to fetch error and /bin/bash AUM due to a backend 500 error. It also suffers from a Ready Clients filter issue, showing only 2 of 3 clients.
    *   **Monthly Obligations Timeline:** The backend logic was fixed, but the UI still shows combined totals instead of a breakdown by client with their correct referral agent.
    *   **Investment Committee & Fund Portfolio Tabs:** The UI is showing incorrect data. New backend endpoints were created, but the frontend likely needs to be updated to call them.
2.  **ADD NEW DATA:** The user has provided several new data allocations for client Guillermo Garcia, which have been added to the database. All calculations must reflect these new totals.
3.  **IMPLEMENT NEW WEALTH CALENDAR:** The user has requested a new UI component to visualize the fund's cash flow, obligations, and performance requirements.
4.  **PROVIDE PROOF:** The agent must not report done until all tabs are 100% functional and verified.

**User's preferred language**: English

**what currently exists?**
The application is a full-stack financial dashboard (React + FastAPI + MongoDB). The production environment is partially functional after the agent fixed a critical authentication blocker.

-   **Backend:** A significant SSOT (Single Source of Truth) refactor has been performed, centralizing logic in . The agent has fixed multiple backend bugs and data integrity issues by updating records directly in the MongoDB database and creating new, corrected API endpoints. However, some key endpoints like  are still throwing 500 errors in production.
-   **Frontend:** The Cash Flow tab API is now working, but the UI needs to be updated to handle the new data structure provided by the backend to show a per-client breakdown. The Investments tab is completely broken due to the backend 500 error. Other tabs may be pointing to old, incorrect APIs.
-   **Data:** All new allocations and data corrections requested by the user (e.g., referral agents, fund types, new investments) have been applied directly to the production MongoDB database. The database is correct, but the API/UI layers are not reflecting it properly.

**Last working item**:
- **Last item agent was working:** The agent was actively debugging two critical issues with the **Investments Tab**:
    1.  A persistent  on the  endpoint.
    2.  A Ready Clients filter issue identified from console logs, where an API was only returning 2 out of 3 active clients.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N (The issues were just identified and are being investigated.)
- **Which testing method agent to use?** Backend testing agent or  to debug the  endpoint and the Ready Clients endpoint. Once the backend is fixed, use the frontend testing agent or screenshot tool to verify the Investments tab UI.
- **User Testing Done:** Y (User provided screenshots and console logs confirming the tab is broken).

**All Pending/In progress Issue list**:
-   **Issue 1: Investments Tab is Broken (P0 - CRITICAL)**
-   **Issue 2: Ready Clients Filter Logic is Incorrect (P0)**
-   **Issue 3: Monthly Obligations Timeline UI is not updated (P1)**
-   **Issue 4: Investment Committee and Fund Portfolio Tabs show incorrect data (P1)**
-   **Issue 5: Lucrum MT5 Bridge Has Duplicate Key Errors (P2)**

**Issues Detail:**
-   **Issue 1: Investments Tab is Broken (P0 - CRITICAL)**
    -   **Attempted fixes:** The endpoint () was refactored, and improved logging was added. The code works locally, but still returns a 500 error in production, even after a successful deployment.
    -   **Next debug checklist:**
        1.  Check the Render logs for the detailed traceback of the 500 error. The agent added logging in commit  which should help pinpoint the exact line causing the failure (likely a  or ).
        2.  Analyze the traceback and apply a fix to the endpoint in .
        3.  Commit the fix and request deployment.
    -   **Why fix this issue and what will be achieved with the fix?** This is a core feature. Fixing it will display the correct AUM, investment list, and client data, unblocking further verification.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on other issue:** None.

-   **Issue 2: Ready Clients Filter Logic is Incorrect (P0)**
    -   **Attempted fixes:** None. This was just identified from user-provided console logs.
    -   **Next debug checklist:**
        1.  Identify the backend endpoint that returns  by searching the codebase.
        2.  Analyze the endpoint's query logic. It is likely filtering clients based on a  field that is not set for all active clients.
        3.  The most robust fix is to modify the backend query to ignore the  filter and rely solely on . Alternatively, update all active client documents in the  collection to have .
    -   **Why fix this issue and what will be achieved with the fix?** This will ensure all active clients are included in application logic, fixing data discrepancies on the Investments tab and potentially other areas.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Backend.
    -   **Blocked on other issue:** None.

-   **Issue 3: Monthly Obligations Timeline UI is not updated (P1)**
    -   **Attempted fixes:** The backend endpoint () was successfully refactored to group data by client and provide a  array (commit ).
    -   **Next debug checklist:**
        1.  Modify the frontend component .
        2.  Update the component's rendering logic to iterate over the new  data structure.
        3.  Display each client's name, their specific payments, and their assigned referral agent, as per the user's detailed UI mockups.
    -   **Why fix this issue and what will be achieved with the fix?** The timeline will become readable and correctly attribute payments to the right clients, fulfilling a key user requirement.
    -   **Status:** IN PROGRESS (Backend done, Frontend pending).
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** None.

-   **Issue 4: Investment Committee and Fund Portfolio Tabs show incorrect data (P1)**
    -   **Attempted fixes:** The agent created new, correct backend endpoints ( and ) that pull data from the correct source of truth ( collection).
    -   **Next debug checklist:**
        1.  The frontend components for these tabs are likely still calling the old, incorrect APIs.
        2.   the frontend codebase to find which components render these tabs.
        3.  Update the API call URL in the respective React components to point to the new  endpoints.
    -   **Why fix this issue and what will be achieved with the fix?** The UI will finally display the correct data that has already been prepared on the backend.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** None.

-   **Issue 5: Lucrum MT5 Bridge Has Duplicate Key Errors (P2)**
    -   **Attempted fixes:** None in this session. Identified in the previous summary.
    -   **Next debug checklist:** Investigate the  service to see why  is failing. Suspected cause is a code version mismatch on the VPS running the service.
    -   **Why fix this issue and what will be achieved with the fix?** Ensures complete historical deal data for Lucrum accounts.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend.
    -   **Blocked on other issue:** None.

**In progress Task List**:
-   **Task 1: Full Platform Stabilization & Data Correction (P0)**
    -   **Where to resume:** Resume by debugging the 500 error on the Investments tab and the Ready Clients filter. Then proceed to fix the remaining UI issues.
    -   **What will be achieved with this?** A fully functional, data-consistent production application that meets all user requirements.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on something:** Debugging the backend 500 error on the Investments tab.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) **Implement Wealth Calendar UI:** Create a new frontend component to display the fund's health, cash flow projections, and performance gaps, as specified by the user. The backend data for this is ready.
    -   (P2) **Configure  for MT5 bridge auto-healing.**
-   **Future Tasks:**
    -   (P2) Fix failing logins for three specific referral agents.
    -   (P2) Remove obsolete V1 API code and frontend components.
    -   (P2) Implement Referral Link Analytics Backend.

**Completed work in this session**
-   **Authentication Fix:** Resolved the critical production login failure by correcting  and deploying the fix.
-   **Data Integrity & Additions:**
    -   Successfully added multiple new allocations for Guillermo Garcia to the  collection and updated the total principal in the  collection.
    -   Fixed incorrect  and  assignments for all clients across the  and  collections in the database.
    -   Corrected  type errors by converting values to  directly in the MongoDB database.
-   **Backend Endpoint Fixes & Creation:**
    -   Fixed the  endpoint.
    -   Refactored the  endpoint to fix hardcoded values and provide a new data structure () grouped by client.
    -   Created new, correct endpoints  and  to resolve incorrect data displays on their respective tabs.
-   **Frontend Debugging:** Added extensive logging to  to help identify and resolve its loading issues.

**Code Architecture**


**Key Technical Concepts**
-   **Single Source of Truth (SSOT):** All financial calculations should originate from the  collection and be processed through . The  collection is for account management, not the primary source for financial logic.
-   **Render Deployment:** The workflow is to fix code, commit, have the user Save to GitHub, which triggers a Render deployment. Production issues often stem from code not being deployed or cached.
-   **UI/API Mismatch:** A recurring theme is that the agent creates new, correct backend endpoints, but the frontend components are not updated to call them. This needs to be checked for all broken tabs.

**All files of reference**
-   **/app/backend/server.py**: Contains all API endpoints, including the broken  and the newly created correct ones like .
-   **/app/backend/services/calculations.py**: The SSOT service. All data logic should flow through here.
-   **/app/frontend/src/components/AdminInvestmentManagement.js**: The React component for the broken Investments tab.
-   **/app/frontend/src/components/CashFlowManagement.js**: The React component for the Monthly Obligations Timeline. Needs UI updates.

**Critical Info for New Agent**
-   **YOU ARE IN A P0 SITUATION.** The user is highly engaged, providing detailed feedback, and expects rapid fixes. The highest priority is fixing the **Investments Tab**.
-   **PRIORITY ORDER:**
    1.  Fix the Investments tab 500 error and the Ready Clients filter.
    2.  Update the Cash Flow UI to display clients separately.
    3.  Verify and fix the Fund Portfolio and Investment Committee tabs by ensuring they call the correct  APIs.
    4.  Implement the new Wealth Calendar UI feature.
-   **TRUST THE DATABASE, NOT THE UI:** The agent has already performed numerous database corrections. The  collection is the source of truth. The current bugs are primarily in the API and UI layers not correctly reflecting this data.
-   **CHECK FOR UI/API MISMATCH:** For tabs showing incorrect data (Fund Portfolio, Investment Committee), it is highly likely the frontend component is still calling an old API endpoint. You must verify the component code and update the URL to the new  endpoint that the previous agent created.

**Last 10 User Messages and any pending user messages**
1.  **Saved to GitHub, redeployed. Make sure all is fixed.** (Pending) - The user has deployed the agent's code and expects a full verification of all tabs.
2.  **Investment Committee tab is completely wrong.** (Partially Fixed) - Agent created a correct backend endpoint, but the frontend likely needs to be updated to call it.
3.  **Investments tab broken.** (In Progress) - User provided a screenshot showing the tab is completely broken.
4.  **Investments tab still broken after deploy.** (In Progress) - User re-confirmed the issue persists.
5.  **Console logs show 500 error and Ready Clients issue.** (In Progress) - User provided critical debugging information.
6.  **Fix Timeline to show client names.** (In Progress) - User requested the timeline UI be restructured to group by client. Backend is done, frontend is pending.
7.  **Provided specs for Wealth Calendar and referral agent fixes.** (Upcoming/Completed) - User wants a new UI feature. Referral agent data has been fixed in the DB.
8.  **Fund Portfolio chart is completely wrong.** (Partially Fixed) - Agent created a correct backend endpoint, but the frontend likely needs to be updated.
9.  **Saved to GitHub.** (Info) - User confirming deployment actions.
10. **Awaiting summary/next steps.** (Info)

**Project Health Check:**
-   **Broken**:
    -   **Investments Tab:** Completely non-functional due to a backend 500 error and a client filtering bug.
    -   **Fund Portfolio Tab / Investment Committee Tab:** Displaying incorrect data, likely due to the frontend calling old API endpoints.
-   **Mocked**: None.

**3rd Party Integrations**
-   **Render:** Used for hosting and deployment. The agent triggers deployments by committing code and having the user sync to GitHub.
-   **MongoDB Atlas:** Production database. The agent has been interacting with it via scripts.

**Testing status**
-   **Testing agent used after significant changes:** YES. Used to verify the Cash Flow tab fix and identify navigation issues.
-   **Troubleshoot agent used after agent stuck in loop:** YES. Used to identify an incorrect API response structure.
-   **Test files created:** None persistent.
-   **Known regressions:** The Investments tab is a major regression.

**Credentials to test flow:**
-   **Admin Username**: 
-   **Admin Password**: 

**What agent forgot to execute**
- The agent has repeatedly created new, correct backend endpoints (e.g., for Fund Portfolio, Investment Committee) but has forgotten to follow through and update the corresponding frontend components to call these new endpoints. This leaves the UI broken despite the backend logic being fixed.
- The agent has not been able to successfully debug the production 500 error on the Investments tab, likely due to not having direct access to Render logs and relying on a slow feedback loop.</analysis>
