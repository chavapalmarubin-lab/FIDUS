<analysis>**original_problem_statement:**
The user's initial request was to build a complete, secure Referral Agent Portal with login, a CRM for lead tracking, and a commission dashboard. After an initial implementation, the user provided extremely detailed feedback, rejecting the work as a complete mess.

The user has now provided a comprehensive multi-page requirements document for a **complete rebuild** of the portal to meet FIDUS standards. Key requirements include:
1.  **UI/UX Overhaul:** The portal must match the existing admin CRM's dark theme (slate-900 background, cyan/teal accents) and professional quality, not the white theme the agent built.
2.  **Dashboard Enhancement:** Integrate the full FIDUS Investment Simulator, a visual sales pipeline (Kanban-style), and business projection tools.
3.  **Commission Page Rebuild:** Implement a visual calendar for the payment schedule, detailed commission cards, and summary metrics. This page is currently broken, showing /bin/bash.
4.  **Full CRM Integration:** The agent portal's CRM must match the power of the admin CRM, including a drag-and-drop Kanban board for lead management.
5.  **Advanced Referral Tools:** The profile page must be upgraded to an agent toolkit with a copyable referral link, QR code generator, link analytics, and downloadable marketing materials.
6.  **Fix Data Issues:** All data-related problems (CORS errors, commissions showing /bin/bash, clients not showing investments) must be fixed. This is linked to a backend deployment issue on Render.

**User's preferred language**: English

**what currently exists?**
The application is a full-stack platform (React, FastAPI, MongoDB) hosted on Render. It has a robust admin-side CRM and an Investment Simulator.

The initial version of the Referral Agent Portal frontend and backend exists but is fundamentally broken and rejected by the user. The backend code contains logic for authentication and CRM endpoints, but it is not correctly deployed on Render, causing all API calls from the live frontend to fail or return incorrect data. The frontend UI has the wrong theme (white instead of dark) and lacks the required functionality and interactivity.

**Last working item**:
-   **Last item agent was working:** The agent acknowledged the user's extensive and critical feedback. In response, the agent created and presented a detailed, 8-phase plan for a complete rebuild of the Referral Agent Portal, aligning with the new, comprehensive requirements. The agent is waiting for the user's approval to start this new plan.
-   **Status:** USER VERIFICATION PENDING
-   **Agent Testing Done:** N/A (A plan was proposed; no new code has been implemented yet).
-   **Which testing method agent to use?** After completing Phase 1, the agent should use  to test backend endpoints. After completing the full rebuild of each frontend page, the  should be used to verify the new dark-theme design. A full  run will be needed after major phases (like CRM and Dashboard rebuild) are complete.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1:** Backend not deployed correctly on Render (P0)
-   **Issue 2:** Referral Portal UI/UX and functionality do not meet requirements (P0)
-   **Issue 3:** Referral link for new agent 'JA-2025' was not working (P2)

**Issues Detail:**
-   **Issue 1:**
    -   **Description:** The live backend on Render is not serving the new CRM API endpoints. All  calls from the frontend are either failing with CORS errors or receiving the frontend's HTML instead of JSON. This is the root cause for all data-related bugs (e.g., commissions showing /bin/bash). The agent corrected the  in  to point to the correct API service (), but the code needs to be pushed to GitHub and the Render services need to be redeployed.
    -   **Attempted fixes:** The agent identified the correct backend URL and updated the  file. The agent also repeatedly asked the user to redeploy.
    -   **Next debug checklist:**
        1.  Ensure the latest code, especially the updated , is saved to GitHub.
        2.  Guide the user to trigger a manual redeployment of BOTH the frontend () and backend () services on Render.
        3.  Verify the fix by calling an API endpoint ({"detail":"Not authenticated"} with a valid token) and confirming it returns JSON.
    -   **Why fix this issue and what will be achieved with the fix?** This is a critical blocker. Fixing it will allow the frontend to communicate with the backend, making it possible to display real data and move forward with the portal rebuild.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both.

-   **Issue 2:**
    -   **Description:** The entire first version of the referral portal is functionally and aesthetically wrong. It has a white theme, not the required dark theme. It's missing the Investment Simulator, a proper CRM, a commission calendar, and advanced referral tools. The user has provided a detailed prompt for a complete rebuild.
    -   **Next debug checklist:** This is not a bug to be fixed, but a large feature to be rebuilt. The agent must follow the 8-phase plan they proposed, starting with Phase 1.
    -   **Why fix this issue and what will be achieved with the fix?** To deliver the product the user actually requested and meet FIDUS's quality standards.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both.

-   **Issue 3:**
    -   **Description:** The referral link for Josselyn () was showing an Invalid referral code error because her code in the database was incorrectly stored as JAL-2025.
    -   **Attempted fixes:** The agent ran a script to find and update the incorrect code in the MongoDB Atlas database.
    -   **Next debug checklist:** After the backend is correctly deployed (Issue 1), re-test the link  to confirm the fix is live.
    -   **Status:** TESTING PENDING
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend.

**In progress Task List**:
-   **Task 1:** Rebuild the Referral Agent Portal (P0)

**Task Detail:**
-   **Task 1:**
    -   **Where to resume:** The user needs to approve the agent's proposed 8-phase plan. Once approved, the agent must start with **Phase 1: Fix Foundation**. This involves fixing all backend data queries and CORS issues, ensuring the correct  is used, and getting real data for agent Salvador Palma to appear correctly on the (soon-to-be-rebuilt) portal.
    -   **What will be achieved with this?** A stable foundation where the frontend can correctly fetch data from the backend on Render, resolving the critical /bin/bash commissions and CORS error problems. This is the first step in the complete portal overhaul.
    -   **Status:** NOT STARTED (Pending user approval of the new plan).
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on something:** User approval of the 8-phase plan.

**Upcoming and Future Tasks**
The agent has proposed a detailed 8-phase plan for the portal rebuild.

-   **Upcoming Tasks:**
    -   **Phase 1: Fix Foundation (P0):** Fix all data-loading issues (CORS, DB queries, Render deployment).
    -   **Phase 2: Investment Simulator Integration (P1):** Embed the existing admin simulator into the agent dashboard.
    -   **Phase 3: Commission Calendar (P1):** Rebuild the commissions page with a visual calendar view.
    -   **Phase 4: Full CRM Pipeline (Kanban) (P1):** Build a drag-and-drop Kanban board for lead management.
-   **Future Tasks:**
    -   **Phase 5: Referral Tools & Analytics (P2):** Add QR codes, link tracking, and marketing materials.
    -   **Phase 6: Profile Enhancement (P2):** Upgrade the profile page with more settings.
    -   **Phase 7: UI Polish & Mobile Optimization (P2):** Final design polish to match the dark theme and ensure mobile responsiveness.
    -   **Phase 8: End-to-End Testing & Bug Fixes (P2):** A final round of comprehensive testing.

**Completed work in this session**
-   **Bug Fix:** The Investment Simulator's ROI calculation was corrected to account for the fund's incubation period, ensuring a 12-month request correctly calculates 12 interest payments (30% ROI) over a 14-month total timeline.
-   **Initial Portal Scaffolding:** Created the file structure and basic components for the referral portal, which are now slated for a complete overhaul.
-   **Backend Data Debugging:** Identified and fixed numerous incorrect database queries in  related to object ID formats, custom string IDs, and  data types.
-   **Deployment Diagnosis:** Correctly identified that the frontend's  file was pointing to the wrong backend URL and that the Render backend service was not deployed with the latest code. The agent has corrected the  file.

**Earlier issues found/mentioned but not fixed**
All previously known issues are now consolidated into the comprehensive rebuild plan for the Referral Agent Portal. The most critical one is the Render deployment/configuration issue.

**Code Architecture**


**Key Technical Concepts**
-   **Frameworks**: React (frontend), FastAPI (backend)
-   **Database**: MongoDB
-   **Styling**: Tailwind CSS, Shadcn/ui
-   **Authentication**: JWT-based for the referral portal
-   **Deployment**: Render.com (with separate services for frontend and backend)

**key DB schema**
-   **salespeople**: Stores agent data.  is used for public-facing links.
-   **clients**: Linked to agents via  (ObjectId or code) and to investments via a custom .
-   **investments**: Linked to clients via  (a custom string like client_alejandro).
-   **referral_commissions**:  is a .  is a string-prefixed ObjectId (e.g., ).

**All files**
-   **/app/backend/server.py**: Updated to fix the investment simulator logic.
-   **/app/backend/routes/referrals.py**: Heavily modified to add and then repeatedly correct all CRM and auth endpoints for the agent portal. This file contains the logic that needs to be deployed to Render.
-   **/app/frontend/src/pages/referral-agent/**: All files within this directory were created for the portal and now require a complete rebuild to match the dark theme and new requirements.
-   **/app/frontend/src/components/LoginSelection.js**: Modified to add the third Referral Agent Login button.
-   **/app/frontend/.env**: Critical file updated to point  to the correct production API service: . This change needs to be pushed to GitHub and deployed.
-   **/app/SYSTEM_MASTER.md**: Updated with a change log entry for the simulator fix.

**Areas that need refactoring**:
-   The **ENTIRE** referral agent portal frontend ( and associated components) needs a complete rebuild to match the FIDUS dark theme, implement the requested features (simulator, CRM, calendar), and fix interactivity. The current implementation was rejected by the user.

**key api endpoints**
-   
-   
-   
-    (Used by the public referral link)
-   

**Critical Info for New Agent**
-   **The user is highly frustrated.** You MUST follow the new 8-phase rebuild plan exactly and get user approval at each stage. Do not deviate or make assumptions. Acknowledge the user's detailed requirements from their last message.
-   **Start with Phase 1: Fix the Foundation.** Do not build new features until the existing data loading is fixed on Render. This means ensuring the latest code (especially the  file) is on GitHub and both frontend/backend services on Render are redeployed.
-   **UI/UX is paramount.** The portal MUST be rebuilt to match the existing admin portal's dark theme and professional quality. Reference screenshots and existing components (, ).
-   **Data queries are complex.** Be mindful of the different ways collections are linked (, custom strings, prefixed strings) and the use of . The queries in  were fixed multiple times; review them carefully.

**Last 5 User Messages and any pending user messages**
1.  **User:** Frustrated with the portal being a complete mess (wrong colors, no UX, broken functionality).
2.  **User:** Approved the agent's proposal to go ahead with a complete rebuild.
3.  **User:** Expressed extreme frustration (you drive me crazy) with the agent's confusion over the Render production environment and requests to change URLs.
4.  **User:** Provided a very long, detailed requirements document for a complete portal rebuild, defining the FIDUS Standard and listing all unacceptable issues.
5.  **Agent:** Acknowledged the user's comprehensive requirements, apologized, and proposed a detailed 8-phase, 3-4 week plan for the rebuild, asking for approval to start with Phase 1. This is the last action, and it is **pending user approval**.

**Project Health Check:**
-   **Broken**: The Referral Agent Portal is non-functional on the production Render environment. The backend service is out-of-date, causing the frontend to fail all data fetches with CORS errors, resulting in incorrect data displays (e.g., /bin/bash commissions) and a broken user experience.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: None in this session.
-   **Known regressions**: The live Referral Portal is entirely non-functional from a data perspective.

**Credentials to test flow:**
-   **Salvador Palma (Agent with data):**
    -   **Email:** 
    -   **Password:** 
-   **Josselyn Arellano LÃ³pez (New agent, no data):**
    -   **Email:** 
    -   **Password:** 

**What agent forgot to execute**
The agent initially failed to understand the user's quality standards and existing design system, leading to the creation of a portal that was immediately rejected. The agent also struggled to diagnose the Render deployment issue, causing significant user frustration. All these issues are now captured in the new, comprehensive rebuild plan.</analysis>
